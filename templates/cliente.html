<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swift | Cliente</title>
    <script src="/static/vendor/echarts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Professional KPI Grid */
        .kpi-grid-professional {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card-pro {
            background: var(--card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .kpi-card-pro:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .kpi-card-pro::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .kpi-card-pro.facturacion::before {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .kpi-card-pro.premium::before {
            background: linear-gradient(90deg, #E84752, #c03942);
        }

        .kpi-card-pro.rebozados::before {
            background: linear-gradient(90deg, #FF9F0A, #d48806);
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 1rem;
        }

        .facturacion .kpi-icon {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .premium .kpi-icon {
            background: linear-gradient(135deg, #E84752, #c03942);
        }

        .rebozados .kpi-icon {
            background: linear-gradient(135deg, #FF9F0A, #d48806);
        }

        .kpi-label-pro {
            font-size: 0.75rem;
            font-weight: 600;
            color: #8E96A3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .kpi-value-pro {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }

        .kpi-unit-pro {
            font-size: 0.9rem;
            color: #8E96A3;
            font-weight: 500;
        }

        .kpi-subtitle {
            font-size: 0.85rem;
            color: #8E96A3;
            margin-top: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .kpi-progress {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .kpi-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease, background 0.3s ease;
        }

        .facturacion .kpi-progress-bar {
            background: linear-gradient(90deg, #3498db, #2ecc71);
        }

        .premium .kpi-progress-bar {
            background: linear-gradient(90deg, #E84752, #f39c12);
        }

        .rebozados .kpi-progress-bar {
            background: linear-gradient(90deg, #FF9F0A, #e67e22);
        }

        .kpi-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .badge-success {
            background: #DCFCE7;
            color: #166534;
        }

        .badge-warning {
            background: #FEF9C3;
            color: #854D0E;
        }

        .badge-danger {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* Tier Badges (Sync with Dashboard) */
        .tier-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 12px;
            vertical-align: middle;
        }

        .tier-aaa {
            background: linear-gradient(135deg, var(--minerva-yellow), #B8860B);
            color: #000;
            box-shadow: 0 0 15px var(--yellow-glow);
        }

        .tier-aa {
            background: linear-gradient(135deg, #E5E4E2, #B4B4B4);
            color: #000;
        }

        .tier-a {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: #fff;
        }

        .tier-b {
            background: #E2E8F0;
            color: #475569;
            border: 1px solid #CBD5E1;
        }

        .tier-cn {
            background: linear-gradient(135deg, #6A5ACD, #483D8B);
            color: #fff;
            box-shadow: 0 0 15px rgba(106, 90, 205, 0.5);
        }

        .chart-card {
            background: #F8FAFF;
            /* Very light blue/white for depth */
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            transition: transform 0.2s;
        }

        .chart-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.04);
        }

        .chart-card h3 {
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--accent);
            padding-left: 12px;
        }

        .score-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            min-width: 320px;
        }

        .score-title {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .score-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
        }

        .score-val {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--primary);
        }

        .score-bar-bg {
            width: 100%;
            height: 6px;
            background: #EDF2F7;
            border-radius: 4px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 2px;
            background: #E84752;
        }


        @media (max-width: 968px) {
            .kpi-grid-professional {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .kpi-grid-professional {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <h1 style="display:flex; align-items:center; gap:10px; font-size: 1.1rem; margin:0;">
            <div
                style="background: var(--minerva-red); color: white; padding: 2px 8px; border-radius: 4px; font-weight: 800; font-size: 1.1rem;">
                M</div>
            <span style="letter-spacing: -0.5px;">Minerva <span
                    style="color: var(--minerva-red); font-weight: 800;">Foods</span></span>
            <span style="font-weight: 300; margin-left: 8px; opacity: 0.5; font-size: 0.85rem;">Detalle Cliente</span>
        </h1>
        <a href="javascript:history.back()" style="font-weight: 600;">‚Üê Volver al Dashboard</a>
    </nav>

    <div class="container">
        <div class="client-header">
            <div>
                <h1 style="display:inline-block; vertical-align:middle" id="client-name">Cargando...</h1>
                <span id="client-tier" class="tier-badge"></span>
                <div class="meta" id="client-meta"></div>
            </div>
            <div id="score-section" class="score-card" style="display:none">
                <div class="score-title">üéØ Ponderaci√≥n Estrat√©gica <span id="total-score-badge"
                        style="font-size:0.9rem; font-weight:800; color:var(--accent)"></span></div>
                <div class="score-grid">
                    <div class="score-item">
                        <div class="score-label">Volumen (Avg 12m)</div>
                        <div class="score-val" id="vol-score-val">0</div>
                        <div class="score-bar-bg">
                            <div class="score-bar-fill" id="vol-score-bar" style="width:0%; background:#3498db"></div>
                        </div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">Profundidad Mix (SKU)</div>
                        <div class="score-val" id="mix-score-val">0</div>
                        <div class="score-bar-bg">
                            <div class="score-bar-fill" id="mix-score-bar" style="width:0%; background:#2ecc71"></div>
                        </div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">Lealtad y Rotaci√≥n</div>
                        <div class="score-val" id="loy-score-val">0</div>
                        <div class="score-bar-bg">
                            <div class="score-bar-fill" id="loy-score-bar" style="width:0%; background:#FF9F0A"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Contact Card -->
        <div id="contact-card" style="display:none; background:var(--card); border:1px solid var(--border); border-radius:14px; padding:1rem 1.5rem; margin-bottom:1.5rem; box-shadow:var(--shadow); display:flex; gap:2rem; flex-wrap:wrap; align-items:center;">
            <div id="contact-direccion" style="display:none; font-size:0.88rem; color:var(--text-secondary);">
                <span style="font-size:0.7rem;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:2px;">Direcci√≥n</span>
                <span id="cc-direccion"></span>
            </div>
            <div id="contact-tel" style="display:none; font-size:0.88rem; color:var(--text-secondary);">
                <span style="font-size:0.7rem;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:2px;">Tel√©fono</span>
                <a id="cc-tel" href="#" style="color:var(--primary);font-weight:600;text-decoration:none;"></a>
            </div>
            <div id="contact-correo" style="display:none; font-size:0.88rem; color:var(--text-secondary);">
                <span style="font-size:0.7rem;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:2px;">Correo</span>
                <a id="cc-correo" href="#" style="color:var(--accent);font-weight:600;text-decoration:none;"></a>
            </div>
            <div id="contact-contacto" style="display:none; font-size:0.88rem; color:var(--text-secondary);">
                <span style="font-size:0.7rem;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:2px;">Contacto</span>
                <span id="cc-contacto" style="font-weight:600;color:var(--text-primary);"></span>
            </div>
            <div id="contact-plazo" style="display:none; font-size:0.88rem; color:var(--text-secondary);">
                <span style="font-size:0.7rem;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:2px;">Plazo</span>
                <span id="cc-plazo" style="font-weight:600;color:var(--text-primary);"></span>
            </div>
            <a id="contact-mapa-link" href="#" style="display:none; margin-left:auto; background:var(--primary); color:white; text-decoration:none; border-radius:8px; padding:0.5rem 1rem; font-size:0.8rem; font-weight:700; white-space:nowrap;">üó∫Ô∏è Ver en mapa</a>
        </div>

        <!-- Gauge Section: Facturaci√≥n $, Premium $, Rebozados KG -->
        <div class="gauge-grid">
            <div class="gauge-card">
                <div class="gauge-label">üí∞ Facturaci√≥n $</div>
                <div class="gauge-value" id="gauge-fact-val">$0</div>
                <div id="gauge-fact" class="gauge-container"></div>
                <div class="gauge-sub" id="gauge-fact-sub">Obj: $0</div>
            </div>
            <div class="gauge-card">
                <div class="gauge-label">‚≠ê Premium $</div>
                <div class="gauge-value" id="gauge-prem-val">$0</div>
                <div id="gauge-prem" class="gauge-container"></div>
                <div class="gauge-sub" id="gauge-prem-sub">Obj: $0</div>
            </div>
            <div class="gauge-card">
                <div class="gauge-label">üçó Rebozados KG</div>
                <div class="gauge-value" id="gauge-reb-val">0 kg</div>
                <div id="gauge-reb" class="gauge-container"></div>
                <div class="gauge-sub" id="gauge-reb-sub">Obj: 0 kg</div>
            </div>
        </div>
        <style>
            .gauge-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1.25rem;
                margin-bottom: 2rem;
            }

            .gauge-card {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 1.5rem;
                box-shadow: var(--shadow);
                text-align: center;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .gauge-card:hover {
                transform: translateY(-3px);
            }

            .gauge-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 4px;
                background: var(--accent);
                opacity: 0.8;
            }

            .chart-container {
                height: 350px;
                width: 100%;
                position: relative;
            }

            .gauge-label {
                font-size: 0.75rem;
                font-weight: 800;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 1.5px;
                margin-bottom: 0.25rem;
            }

            .gauge-container {
                width: 100%;
                height: 200px;
            }

            .gauge-value {
                font-size: 1.75rem;
                font-weight: 900;
                color: var(--primary);
                line-height: 1.2;
                margin-bottom: -10px;
            }

            .gauge-sub {
                font-size: 0.9rem;
                color: var(--text-muted);
                font-weight: 700;
                margin-top: -10px;
                letter-spacing: 0.5px;
                padding-bottom: 0.5rem;
                text-transform: uppercase;
            }

            @media (max-width: 900px) {
                .gauge-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <div class="controls">
            <style>
                .controls {
                    display: flex;
                    gap: 2rem;
                    justify-content: center;
                    margin-bottom: 2rem;
                    flex-wrap: wrap;
                }

                .btn-group {
                    background: #F1F5F9;
                    border-radius: 50px;
                    padding: 4px;
                    display: inline-flex;
                    gap: 2px;
                    border: 1px solid var(--border);
                }

                .btn {
                    padding: 8px 20px;
                    border: none;
                    background: transparent;
                    color: var(--text-muted);
                    font-size: 0.85rem;
                    font-weight: 700;
                    border-radius: 50px;
                    cursor: pointer;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    position: relative;
                    overflow: hidden;
                }

                .btn:hover:not(.active) {
                    color: var(--primary);
                    background: var(--card-hover);
                }

                .btn.active {
                    background: linear-gradient(135deg, #E84752, #c03942);
                    color: white;
                    box-shadow: 0 4px 12px rgba(232, 71, 82, 0.4);
                }

                .btn::before {
                    content: '';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    width: 0;
                    height: 0;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.2);
                    transform: translate(-50%, -50%);
                    transition: width 0.6s, height 0.6s;
                }

                .btn:active::before {
                    width: 300px;
                    height: 300px;
                }
            </style>
            <div class="btn-group">
                <button class="btn" data-meses="3">3 Meses</button>
                <button class="btn active" data-meses="6">6 Meses</button>
                <button class="btn" data-meses="12">12 Meses</button>
            </div>
            <div class="btn-group">
                <button class="btn active" data-tipo="kg">KG</button>
                <button class="btn" data-tipo="importe">Pesos ($)</button>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card chart-full">
                <h3>Evoluci√≥n de Compras <span id="hist-periodo-label"
                        style="font-size:0.75rem;color:#8E96A3;font-weight:400;"></span></h3>
                <div id="chart-historia" class="chart-container"></div>
            </div>
            <div class="chart-card">
                <h3>Compras por Categor√≠a <span id="cat-periodo-label"
                        style="font-size:0.75rem;color:#8E96A3;font-weight:400;"></span></h3>
                <div id="chart-categorias" class="chart-container" style="height:280px;"></div>
                <div class="category-legend" id="category-legend"></div>
            </div>
            <div class="chart-card">
                <h3>Top Productos <span id="periodo-label"
                        style="font-size:0.75rem;color:#8E96A3;font-weight:400;"></span></h3>
                <div id="chart-productos" class="chart-container"></div>
            </div>
            <div class="chart-card">
                <h3>Recurrencia Mensual <span style="font-size:0.75rem;color:#8E96A3;font-weight:400;">compras en los
                        √∫ltimos meses</span></h3>
                <div id="chart-recurrencia" class="chart-container"></div>
            </div>
        </div>

        <!-- Coberturas de Lanzamientos -->
        <style>
            .lanz-section {
                margin-top: 2.5rem;
            }

            .lanz-title {
                font-size: 16px;
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: 16px;
                border-left: 3px solid #E84752;
                padding-left: 12px;
            }

            .lanz-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 12px;
            }

            .lanz-card {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 14px;
                text-align: center;
                box-shadow: var(--shadow);
                transition: all 0.2s;
            }

            .lanz-card:hover {
                transform: translateY(-2px);
            }

            .lanz-card .lanz-name {
                font-size: 12px;
                font-weight: 700;
                color: #aaa;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 8px;
            }

            .lanz-badge {
                display: inline-block;
                padding: 3px 10px;
                border-radius: 10px;
                font-size: 10px;
                font-weight: 800;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .lanz-badge.comp {
                background: rgba(52, 199, 89, 0.15);
                color: #34c759;
            }

            .lanz-badge.sinc {
                background: rgba(255, 159, 10, 0.15);
                color: #ff9f0a;
            }

            .lanz-badge.noc {
                background: rgba(232, 71, 82, 0.15);
                color: #E84752;
            }

            .lanz-kg {
                font-size: 20px;
                font-weight: 800;
                color: var(--text-primary);
                margin: 8px 0 2px;
            }

            .lanz-prom {
                font-size: 11px;
                color: #555;
            }

            .lanz-minibar {
                height: 4px;
                background: var(--border);
                border-radius: 2px;
                margin-top: 8px;
                overflow: hidden;
            }

            .lanz-minibar-fill {
                height: 100%;
                border-radius: 2px;
            }
        </style>
        <div class="lanz-section" id="lanz-section" style="display:none">
            <div class="lanz-title">Coberturas de Lanzamientos</div>
            <div class="lanz-grid" id="lanz-grid"></div>
        </div>

    </div>

    <script>
        const codCliente = window.location.pathname.split('/').pop();
        const urlParams = new URLSearchParams(window.location.search);
        const vendedor = urlParams.get('vendedor');

        let currentMeses = 6;
        let currentTipo = 'kg';
        let clienteData = null;

        const BRAND_COLORS = ['#E84752', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#e91e63', '#00bcd4', '#ff5722', '#607d8b', '#8bc34a'];

        function formatPesos(val) {
            if (!val) return '$0';
            if (val >= 1000000) return '$' + (val / 1000000).toFixed(1) + 'M';
            if (val >= 1000) return '$' + (val / 1000).toFixed(0) + 'K';
            return '$' + Math.round(val).toLocaleString('es-AR');
        }

        function formatKg(val) {
            if (!val) return '0 kg';
            if (val >= 1000) return (val / 1000).toFixed(1).replace('.', ',') + ' t';
            return Math.round(val).toLocaleString('es-AR') + ' kg';
        }

        function formatValue(val, tipo) {
            if (!val) return '0';
            if (tipo === 'importe') return '$' + Math.round(val).toLocaleString('es-AR');
            return formatKg(val);
        }

        function getBadgeClass(pct) {
            if (pct >= 80) return 'badge-success';
            if (pct >= 50) return 'badge-warning';
            return 'badge-danger';
        }

        async function loadCliente() {
            let url = `/api/cliente/${codCliente}?meses=${currentMeses}`;
            if (vendedor) url += `&vendedor=${vendedor}`;

            const response = await fetch(url);
            const raw = await response.json();
            if (raw.status === 'success') {
                clienteData = raw.data;
            } else {
                clienteData = raw;
            }

            if (clienteData.error) { alert(clienteData.error); return; }

            const cl = clienteData.cliente;

            // Header
            document.getElementById('client-name').textContent = cl?.nom_cliente || 'Cliente';
            document.getElementById('client-meta').textContent =
                `Frecuencia: ${cl?.frecuencia || 'N/A'} ‚Ä¢ Vendedor: ${clienteData.avance?.nom_vendedor || 'N/A'}`;

            // Tier & Score
            if (cl?.tier) {
                const tierBadge = document.getElementById('client-tier');
                tierBadge.textContent = cl.tier;
                tierBadge.className = `tier-badge tier-${cl.tier.toLowerCase()}`;

                document.getElementById('score-section').style.display = 'block';
                document.getElementById('total-score-badge').textContent = `Score: ${cl.score}/100`;

                // Details
                document.getElementById('vol-score-val').textContent = cl.vol_score;
                document.getElementById('vol-score-bar').style.width = (cl.vol_score / 40 * 100) + '%';

                document.getElementById('mix-score-val').textContent = cl.mix_score;
                document.getElementById('mix-score-bar').style.width = (cl.mix_score / 30 * 100) + '%';

                document.getElementById('loy-score-val').textContent = cl.loyalty_score;
                document.getElementById('loy-score-bar').style.width = (cl.loyalty_score / 30 * 100) + '%';
            }

            // Contact card
            renderContactCard(cl);

            renderGauges();
            renderCharts();
        }


        function renderContactCard(cl) {
            const show = (id, val) => {
                if (val && String(val).trim() && String(val).trim() !== 'nan') {
                    document.getElementById(id).style.display = 'block';
                    return true;
                }
                return false;
            };
            let hasAny = false;
            if (show('contact-direccion', cl.direccion)) {
                document.getElementById('cc-direccion').textContent =
                    [cl.direccion, cl.ciudad, cl.provincia].filter(Boolean).join(', ');
                hasAny = true;
            } else if (cl.ciudad) {
                document.getElementById('contact-direccion').style.display = 'block';
                document.getElementById('cc-direccion').textContent =
                    [cl.ciudad, cl.provincia].filter(Boolean).join(', ');
                hasAny = true;
            }
            if (show('contact-tel', cl.telefono)) {
                const tel = String(cl.telefono).replace('.0', '');
                document.getElementById('cc-tel').textContent = tel;
                document.getElementById('cc-tel').href = 'tel:+' + tel.replace(/\D/g, '');
                hasAny = true;
            }
            if (show('contact-correo', cl.correo)) {
                document.getElementById('cc-correo').textContent = cl.correo;
                document.getElementById('cc-correo').href = 'mailto:' + cl.correo;
                hasAny = true;
            }
            if (show('contact-contacto', cl.contacto)) {
                document.getElementById('cc-contacto').textContent = cl.contacto;
                hasAny = true;
            }
            if (show('contact-plazo', cl.plazo)) {
                document.getElementById('cc-plazo').textContent = cl.plazo + ' d√≠as';
                hasAny = true;
            }
            const codCliente = window.location.pathname.split('/').pop();
            const vendedorParam = new URLSearchParams(window.location.search).get('vendedor') || '';
            const mapaLink = document.getElementById('contact-mapa-link');
            mapaLink.href = `/mapa?vendedor=${vendedorParam}#${codCliente}`;
            mapaLink.style.display = hasAny ? 'inline-block' : 'none';

            if (hasAny) document.getElementById('contact-card').style.display = 'flex';
        }

        function renderGauges() {
            if (!clienteData.avance) return;
            const av = clienteData.avance;

            const f = av; // Assuming 'f' refers to current actuals
            const o = av; // Assuming 'o' refers to current objectives

            renderSingleGauge('gauge-fact', f.facturacion_pesos || 0, o.objetivo_pesos || 0, formatPesos, 'gauge-fact-sub');
            renderSingleGauge('gauge-prem', f.premium_pesos || 0, o.objetivo_premium_pesos || 0, formatPesos, 'gauge-prem-sub');
            renderSingleGauge('gauge-reb', f.rebozados_kg || 0, o.objetivo_rebozados_kg || 0, formatKg, 'gauge-reb-sub');
        }

        function renderSingleGauge(id, actual, objetivo, fmtFn, subId) {
            const dom = document.getElementById(id);
            if (!dom) return;
            const existing = echarts.getInstanceByDom(dom);
            if (existing) existing.dispose();
            const chart = echarts.init(dom);

            const MAX = 130;
            const pct = objetivo > 0 ? Math.min((actual / objetivo) * 100, MAX) : 0;
            const pctRaw = objetivo > 0 ? (actual / objetivo) * 100 : 0;

            chart.setOption({
                backgroundColor: 'transparent',
                series: [{
                    type: 'gauge',
                    startAngle: 210,
                    endAngle: -30,
                    min: 0,
                    max: MAX,
                    radius: '100%',
                    center: ['50%', '65%'],
                    splitNumber: 13,
                    axisLine: {
                        lineStyle: {
                            width: 10, // Thinner, more elegant track
                            color: [
                                [0.40, '#E84752'], // Red
                                [0.70, '#F6AD55'], // Yellow
                                [0.90, '#68D391'], // Soft Green
                                [1.00, '#38A169']  // Strong Green
                            ]
                        }
                    },
                    progress: {
                        show: true, width: 10,
                        itemStyle: { color: 'rgba(29, 53, 87, 0.1)' }
                    },
                    splitLine: { length: 8, lineStyle: { color: '#CBD5E1', width: 1.5 } },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#64748B', fontSize: 10, distance: 15, fontWeight: '600',
                        formatter: v => v % 20 === 0 ? v : ''
                    },
                    pointer: {
                        length: '75%', width: 5, icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z',
                        offsetCenter: [0, '-10%'],
                        itemStyle: { color: '#1D3557', shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.1)' }
                    },
                    anchor: {
                        show: true, showAbove: true, size: 10,
                        itemStyle: { color: '#1D3557', borderColor: '#fff', borderWidth: 2 }
                    },
                    detail: {
                        valueAnimation: true,
                        offsetCenter: [0, '25%'],
                        formatter: () => `{pct|${pctRaw.toFixed(1)}%}`,
                        rich: {
                            pct: {
                                fontSize: 16, color: pct >= 100 ? '#10B981' : '#475569',
                                fontWeight: '800', lineHeight: 24,
                                backgroundColor: '#F8FAFC', padding: [4, 12], borderRadius: 6,
                                borderBottom: '2px solid' + (pct >= 100 ? '#10B981' : '#CBD5E1')
                            }
                        }
                    },
                    data: [{ value: parseFloat(pct.toFixed(1)) }]
                }]
            });

            // Update value label and sub-label
            const valId = id + '-val';
            const valEl = document.getElementById(valId);
            if (valEl) valEl.textContent = fmtFn(actual);
            if (subId) document.getElementById(subId).textContent = `OBJ: ${fmtFn(objetivo)}`;
        }  // ‚Üê cierra renderSingleGauge

        function getChart(id) {
                const dom = document.getElementById(id);
                if (!dom) {
                    console.error(`ECharts: Elemento #${id} no encontrado.`);
                    return null;
                }
                // Fix: ensure container has height. If not, set it.
                if (dom.clientHeight === 0) {
                    dom.style.height = '350px';
                }
                try {
                    const existing = echarts.getInstanceByDom(dom);
                    if (existing) existing.dispose();
                    return echarts.init(dom);
                } catch (e) {
                    console.error(`ECharts: Error inicializando #${id}:`, e);
                    return null;
                }
            }

            function renderCharts() {
            try { renderHistoriaChart(); } catch(e) { console.error('Historia chart error:', e); }
            try { renderCategoriasChart(); } catch(e) { console.error('Categorias chart error:', e); }
            try { renderProductosChart(); } catch(e) { console.error('Productos chart error:', e); }
            try { renderRecurrenciaChart(); } catch(e) { console.error('Recurrencia chart error:', e); }
        }

            const MESES_ES = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const formatYM = (ym) => {
                if (!ym) return '';
                const [y, m] = ym.split('-');
                return `${MESES_ES[parseInt(m) - 1]} '${y.substring(2)}`;
            };

            function renderHistoriaChart() {
                const chart = getChart('chart-historia');
                if (!chart) return;
                const allData = clienteData.historia || [];
                // If currentMeses is 12 (default), and we have 14, show all 14 to satisfy "Jan 2025 onwards"
                const data = currentMeses >= 12 ? allData : allData.slice(-currentMeses);

                // Update period label
                if (data.length) {
                    document.getElementById('hist-periodo-label').textContent =
                        `¬∑ ${formatYM(data[0].year_month)} ‚Üí ${formatYM(data[data.length - 1].year_month)}`;
                }

                const field = currentTipo === 'importe' ? 'total_importe' : 'total_kg';
                const values = data.map(h => h[field] || h.total_kg || 0);
                const maxVal = Math.max(...values, 1);

                chart.setOption({
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        borderColor: '#E2E8F0',
                        textStyle: { color: '#1E293B', fontSize: 13 },
                        formatter: params => {
                            const p = params[0];
                            const originalYM = data[p.dataIndex].year_month;
                            return `<strong>${formatYM(originalYM)}</strong><br/>${currentTipo === 'importe' ? formatPesos(p.value) : formatKg(p.value)}`;
                        }
                    },
                    grid: { top: 40, right: 20, bottom: 45, left: 70 },
                    xAxis: {
                        type: 'category',
                        data: data.map(h => formatYM(h.year_month)),
                        axisLabel: { fontSize: 10, color: '#475569', fontWeight: '600', rotate: data.length > 10 ? 30 : 0 },
                        axisLine: { lineStyle: { color: '#CBD5E1' } },
                        axisTick: { show: false }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            fontSize: 10,
                            color: '#475569',
                            fontWeight: '600',
                            formatter: v => currentTipo === 'importe'
                                ? (v >= 1000000 ? '$' + (v / 1000000).toFixed(1) + 'M' : '$' + (v / 1000).toFixed(0) + 'K')
                                : (v >= 1000 ? (v / 1000).toFixed(1) + 't' : v + ' kg')
                        },
                        splitLine: { lineStyle: { color: '#E2E8F0', type: 'dashed' } }
                    },
                    series: [{
                        type: 'bar',
                        data: data.map(h => {
                            const val = h[field] || h.total_kg || 0;
                            const intensity = maxVal > 0 ? val / maxVal : 0;
                            return {
                                value: val,
                                itemStyle: {
                                    color: {
                                        type: 'linear', x: 0, y: 0, x2: 0, y2: 1,
                                        colorStops: [
                                            { offset: 0, color: val === maxVal ? '#E84752' : '#1D3557' },
                                            { offset: 1, color: val === maxVal ? 'rgba(232,71,82, 0.4)' : 'rgba(29, 53, 87, 0.4)' }
                                        ]
                                    },
                                    borderRadius: [5, 5, 0, 0]
                                }
                            };
                        }),
                        barWidth: '55%',
                        label: {
                            show: true,
                            position: 'top',
                            color: '#1D3557',
                            fontSize: 10,
                            fontWeight: 'bold',
                            formatter: params => currentTipo === 'importe'
                                ? formatPesos(params.value)
                                : formatKg(params.value)
                        }
                    }]
                });
            }

            function renderCategoriasChart() {
                const chart = getChart('chart-categorias');
                if (!chart) return;
                const field = currentTipo === 'importe' ? 'total_importe' : 'total_kg';
                const data = (clienteData.categorias || [])
                    .filter(c => (c[field] || 0) > 0)
                    .slice(0, 8);

                const total = data.reduce((s, c) => s + (c[field] || 0), 0);

                // Update label
                document.getElementById('cat-periodo-label').textContent =
                    `¬∑ √∫ltimos ${currentMeses} meses`;

                chart.setOption({
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        borderColor: '#E2E8F0',
                        textStyle: { color: '#1E293B' },
                        borderWidth: 1
                    },
                    legend: { show: false },
                    series: [{
                        type: 'pie',
                        radius: ['45%', '75%'],
                        center: ['50%', '50%'],
                        avoidLabelOverlap: true,
                        itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
                        label: {
                            show: true,
                            position: 'outside',
                            formatter: params => {
                                const pct = total > 0 ? (params.value / total * 100).toFixed(1) : '0';
                                return `{name|${params.name.substring(0, 12)}}\n{pct|${pct}%}`;
                            },
                            rich: {
                                name: { color: '#1E293B', fontSize: 10, lineHeight: 16 },
                                pct: { color: '#1E293B', fontSize: 12, fontWeight: 'bold', lineHeight: 18 }
                            }
                        },
                        labelLine: { length: 10, length2: 8, lineStyle: { color: '#E2E8F0' } },
                        emphasis: {
                            itemStyle: { shadowBlur: 15, shadowColor: 'rgba(232,71,82,0.5)' },
                            scale: true, scaleSize: 5
                        },
                        data: data.map((c, i) => ({
                            value: c[field] || 0,
                            name: c.categoria,
                            itemStyle: { color: BRAND_COLORS[i % BRAND_COLORS.length] }
                        }))
                    }]
                });

                // Rich legend below chart
                document.getElementById('category-legend').innerHTML = data.map((c, i) => {
                    const val = c[field] || 0;
                    const pct = total > 0 ? (val / total * 100).toFixed(1) : '0';
                    return `
                    <div class="legend-item" style="justify-content:space-between; padding:6px 0; border-bottom:1px solid var(--border)">
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="legend-dot" style="background: ${BRAND_COLORS[i % BRAND_COLORS.length]}; min-width:10px; min-height:10px; border-radius:3px"></div>
                            <span style="font-size:0.85rem; color:var(--text-muted); font-weight:600">${c.categoria}</span>
                        </div>
                        <div style="display:flex;gap:12px;align-items:center">
                            <span style="font-size:0.85rem; color:var(--text-primary); font-weight:800">${formatValue(val, currentTipo)}</span>
                            <span style="font-size:0.8rem; color:var(--accent); font-weight:800; min-width:38px; text-align:right">${pct}%</span>
                        </div>
                    </div>`;
                }).join('');
            }

            function renderProductosChart() {
                const chart = getChart('chart-productos');
                if (!chart) return;
                const field = currentTipo === 'importe' ? 'total_importe' : 'total_kg';
                const data = (clienteData.productos || [])
                    .filter(p => (p[field] || 0) > 0)
                    .slice(0, 12)
                    .reverse();

                // Update period label
                document.getElementById('periodo-label').textContent = `¬∑ √∫ltimos ${currentMeses} meses`;

                if (data.length === 0) {
                    chart.setOption({
                        graphic: [{
                            type: 'text', left: 'center', top: 'middle',
                            style: { text: 'Sin datos de productos', fill: '#8E96A3', fontSize: 14 }
                        }]
                    });
                    return;
                }

                chart.setOption({
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        borderColor: '#E2E8F0',
                        textStyle: { color: '#1E293B' },
                        borderWidth: 1
                    },
                    grid: { top: 8, right: 120, bottom: 8, left: 12, containLabel: true },
                    xAxis: { type: 'value', show: false },
                    yAxis: {
                        type: 'category',
                        data: data.map(c => c.nombre_producto.substring(0, 32)),
                        axisLine: { show: false },
                        axisTick: { show: false },
                        axisLabel: { color: '#64748B', fontSize: 10, fontWeight: 600 }
                    },
                    series: [{
                        type: 'bar',
                        data: data.map((c, i) => ({
                            value: c[field] || 0,
                            itemStyle: {
                                color: {
                                    type: 'linear', x: 0, y: 0, x2: 1, y2: 0,
                                    colorStops: [
                                        { offset: 0, color: BRAND_COLORS[i % BRAND_COLORS.length] },
                                        { offset: 1, color: BRAND_COLORS[i % BRAND_COLORS.length] + '99' }
                                    ]
                                },
                                borderRadius: [0, 5, 5, 0]
                            }
                        })),
                        label: {
                            show: true,
                            position: 'right',
                            formatter: p => formatValue(p.value, currentTipo),
                            fontSize: 10,
                            color: '#1E293B',
                            fontWeight: '800'
                        },
                        barWidth: 14,
                        barMinHeight: 4
                    }]
                });
            }

            function renderRecurrenciaChart() {
                const chart = getChart('chart-recurrencia');
                if (!chart) return;
                const allData = clienteData.historia || [];
                const data = allData.slice(-currentMeses);

                if (data.length === 0) {
                    chart.setOption({
                        graphic: [{
                            type: 'text', left: 'center', top: 'middle',
                            style: { text: 'Sin datos hist√≥ricos', fill: '#8E96A3', fontSize: 14 }
                        }]
                    });
                    return;
                }

                const totalMeses = data.length;
                const mesesConCompra = data.filter(h => (h.total_kg || 0) > 0).length;
                const recurrenciaPct = totalMeses > 0 ? Math.round(mesesConCompra / totalMeses * 100) : 0;
                const avgKg = mesesConCompra > 0
                    ? data.filter(h => h.total_kg > 0).reduce((s, h) => s + h.total_kg, 0) / mesesConCompra
                    : 0;

                chart.setOption({
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        borderColor: '#E2E8F0',
                        textStyle: { color: '#1E293B' },
                        borderWidth: 1,
                        shadowBlur: 10,
                        shadowColor: 'rgba(0,0,0,0.1)'
                    },
                    graphic: [{
                        type: 'group', left: 'center', top: 10,
                        children: [
                            {
                                type: 'text', style: {
                                    text: `${recurrenciaPct}% recurrencia ¬∑ ${mesesConCompra}/${totalMeses} meses activos ¬∑ Promedio: ${formatKg(avgKg)}/mes`,
                                    fill: '#64748B', fontSize: 11, textAlign: 'center'
                                }
                            }
                        ]
                    }],
                    grid: { top: 40, right: 20, bottom: 45, left: 70 },
                    xAxis: {
                        type: 'category',
                        data: data.map(h => h.year_month),
                        axisLabel: { fontSize: 10, color: '#64748B', rotate: data.length > 8 ? 30 : 0 },
                        axisLine: { lineStyle: { color: '#E2E8F0' } },
                        axisTick: { show: false }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            fontSize: 10, color: '#64748B',
                            formatter: v => v >= 1000 ? (v / 1000).toFixed(1) + 't' : v + ' kg'
                        },
                        splitLine: { lineStyle: { color: '#E2E8F0' } }
                    },
                    series: [{
                        type: 'bar',
                        data: data.map(h => {
                            const val = h.total_kg || 0;
                            const active = val > 0;
                            return {
                                value: val,
                                itemStyle: {
                                    color: active
                                        ? {
                                            type: 'linear', x: 0, y: 0, x2: 0, y2: 1,
                                            colorStops: [{ offset: 0, color: '#2ecc71' }, { offset: 1, color: '#1a8a4a' }]
                                        }
                                        : 'rgba(231,76,60,0.25)',
                                    borderRadius: [4, 4, 0, 0]
                                }
                            };
                        }),
                        barWidth: '55%',
                        markLine: avgKg > 0 ? {
                            silent: true,
                            symbol: 'none',
                            lineStyle: { color: '#f39c12', type: 'dashed', width: 1.5 },
                            data: [{ yAxis: avgKg, label: { formatter: 'Promedio', color: '#f39c12', fontSize: 10 } }]
                        } : undefined
                    }]
                });
            }

            document.querySelectorAll('.btn[data-meses]').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.btn[data-meses]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMeses = parseInt(this.dataset.meses);
                    loadCliente();
                });
            });

            document.querySelectorAll('.btn[data-tipo]').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.btn[data-tipo]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTipo = this.dataset.tipo;
                    renderCharts();
                });
            });

            window.addEventListener('resize', () => {
                ['chart-historia', 'chart-categorias', 'chart-productos', 'chart-recurrencia'].forEach(id => {
                    echarts.getInstanceByDom(document.getElementById(id))?.resize();
                });
            });

            // ‚îÄ‚îÄ‚îÄ Coberturas de Lanzamientos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            async function loadCoberturas() {
                try {
                    const res = await fetch(`/api/cliente/${codCliente}/coberturas`);
                    const data = await res.json();
                    if (!data || !data.length) return;

                    document.getElementById('lanz-section').style.display = '';
                    const grid = document.getElementById('lanz-grid');
                    grid.innerHTML = data.map(d => {
                        const bcls = d.estado === 'COMPRADOR' ? 'comp' : d.estado === 'SIN COMPRA' ? 'sinc' : 'noc';
                        const barColor = d.estado === 'COMPRADOR' ? '#34c759' : d.estado === 'SIN COMPRA' ? '#ff9f0a' : '#E84752';
                        const prom = d.promedio_u3 || 1;
                        const pct = Math.min(100, (d.total_feb / prom) * 100).toFixed(0);
                        return `<div class="lanz-card">
                        <div class="lanz-name">${d.lanzamiento}</div>
                        <span class="lanz-badge ${bcls}">${d.estado}</span>
                        <div class="lanz-kg">${(d.total_feb || 0).toLocaleString('es-AR', { maximumFractionDigits: 1 })} <span style="font-size:12px;color:#555">KG</span></div>
                        <div class="lanz-prom">Prom 3M: ${(d.promedio_u3 || 0).toLocaleString('es-AR', { maximumFractionDigits: 1 })} KG</div>
                        <div class="lanz-minibar"><div class="lanz-minibar-fill" style="width:${pct}%;background:${barColor}"></div></div>
                    </div>`;
                    }).join('');
                } catch (e) { console.warn('Coberturas not available', e); }
            }

            loadCliente();
            loadCoberturas();
    </script>
</body>

</html>