<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swift | Planificaci√≥n</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .date-selector {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        /* Specific overrides for Planning */
        .kpi-card .value-small {
            font-size: 1.4rem;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }
        th.sortable:hover { background: #E2E8F0; }
        th.sortable::after { content: ' ‚Üï'; font-size: 0.6rem; opacity: 0.4; }
        th.sortable.sort-asc::after { content: ' ‚ñ≤'; opacity: 1; color: var(--accent); }
        th.sortable.sort-desc::after { content: ' ‚ñº'; opacity: 1; color: var(--accent); }

        .client-link {
            color: var(--text-primary);
            font-weight: 600;
            text-decoration: none;
        }
        .client-link:hover { color: var(--primary); text-decoration: underline; }
    </style>
</head>

<body>
    <nav class="navbar">
        <a class="navbar-brand" href="javascript:history.back()">
            <span class="brand-name">Minerva <span class="brand-accent">Foods</span></span>
            <span class="brand-sub">Planificaci√≥n</span>
        </a>
        <div class="navbar-links" id="nav-links-planning">
            <a href="#" id="nav-dashboard-link">üìà Dashboard</a>
            <a href="#" id="nav-coberturas-link">üì¶ Coberturas</a>
            <a href="#" id="nav-mapa-link">üó∫Ô∏è Mapa</a>
        </div>
        <div class="navbar-extra">
            <a href="javascript:history.back()">‚Üê Volver</a>
        </div>
    </nav>
    <script>
        (function() {
            const qs = new URLSearchParams(window.location.search);
            const p = qs.toString() ? '?' + qs.toString() : '';
            document.getElementById('nav-dashboard-link').href = '/dashboard' + p;
            document.getElementById('nav-coberturas-link').href = '/coberturas' + p;
            document.getElementById('nav-mapa-link').href = '/mapa' + p;
        })();
    </script>

    <div class="container">
        <div class="header-row">
            <div>
                <h2>Objetivos del D√≠a</h2>
                <div class="meta" id="day-meta">Cargando...</div>
            </div>
            <div>
                <input type="date" id="planning-date" class="date-selector">
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="label">Objetivo Promedio</div>
                <div class="value value-small" id="kpi-daily-avg">-</div>
                <div class="unit">Base</div>
                <div class="meta">Mensual / 20 d√≠as</div>
            </div>

            <div class="kpi-card" style="border-color: var(--accent);">
                <div class="label" style="color: var(--accent);">Necesario Hoy</div>
                <div class="value value-small" style="color: var(--accent);" id="kpi-daily-needed">-</div>
                <div class="unit">Para Cumplir</div>
                <div class="meta"
                    title="Calculado como: (Objetivo Mensual - Ventas Acumuladas) / D√≠as H√°biles Restantes">Brecha /
                    D√≠as Restantes</div>
            </div>

            <div class="kpi-card">
                <div class="label">Clientes a Visitar</div>
                <div class="value" id="kpi-clients-count">-</div>
                <div class="unit">Hoy</div>
            </div>

            <div class="kpi-card">
                <div class="label">Suma Objetivos Clientes</div>
                <div class="value value-small"><span id="kpi-clients-sum">-</span></div>
                <div class="unit">Planificado (Excel)</div>
                <div class="meta">Hist√≥rico: <span id="kpi-clients-hist">-</span></div>
            </div>
        </div>

        <div class="table-card">
            <div class="header">
                <h3>Clientes a Visitar (<span id="table-count">0</span>)</h3>
                <div class="meta">Frecuencia: <span id="target-freq">-</span></div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="sortable" onclick="changeSort('nom_cliente')">Cliente</th>
                        <th class="sortable" onclick="changeSort('frecuencia')">Frecuencia</th>
                        <th class="sortable text-right" onclick="changeSort('historico')">Prom. Hist√≥rico</th>
                        <th class="sortable text-right" onclick="changeSort('objetivo')">Objetivo Mensual</th>
                        <th class="sortable text-right" onclick="changeSort('facturacion')">Facturado</th>
                        <th class="sortable text-right" onclick="changeSort('pendiente')">Pendiente</th>
                        <th class="sortable" onclick="changeSort('pct')">Estado</th>
                    </tr>
                </thead>
                <tbody id="planning-table">
                    <!-- JS populated -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const vendedor = urlParams.get('vendedor');
        const jefe = urlParams.get('jefe');
        const zona = urlParams.get('zona');

        const dateInput = document.getElementById('planning-date');
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = urlParams.get('date') || today;
        dateInput.addEventListener('change', () => loadPlanning());

        const formatKg = (val) => Math.round(val || 0).toLocaleString('es-AR') + ' kg';

        let allClients = [];
        let sortKey = 'objetivo';
        let sortAsc = false;

        function getPct(c) {
            return c.objetivo ? ((c.facturacion || 0) + (c.pendiente || 0)) / c.objetivo * 100 : 0;
        }

        function changeSort(key) {
            if (sortKey === key) {
                sortAsc = !sortAsc;
            } else {
                sortKey = key;
                sortAsc = (key === 'nom_cliente' || key === 'frecuencia');
            }
            renderTable(allClients);
        }

        function renderTable(clients) {
            // Update header indicators
            document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
            document.querySelectorAll('th.sortable').forEach(th => {
                if (th.getAttribute('onclick') === `changeSort('${sortKey}')`) {
                    th.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');
                }
            });

            const sorted = [...clients].sort((a, b) => {
                let v1 = sortKey === 'pct' ? getPct(a) : (a[sortKey] ?? '');
                let v2 = sortKey === 'pct' ? getPct(b) : (b[sortKey] ?? '');
                if (typeof v1 === 'string') v1 = v1.toLowerCase();
                if (typeof v2 === 'string') v2 = v2.toLowerCase();
                if (v1 < v2) return sortAsc ? -1 : 1;
                if (v1 > v2) return sortAsc ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('planning-table');
            tbody.innerHTML = sorted.map(c => {
                const pct = getPct(c);
                const statusClass = pct >= 80 ? 'success' : pct >= 50 ? 'warning' : 'danger';
                const sinCompra = (c.facturacion || 0) === 0 && (c.objetivo || 0) > 0;
                const rowClass = sinCompra ? 'row-sin-compra' : '';

                return `<tr class="${rowClass}" onclick="window.location.href='/cliente/${c.cod_cliente}?vendedor=${vendedor || ''}'" style="cursor:pointer">
                    <td><strong>${c.nom_cliente || '-'}</strong>${sinCompra ? ' <span title="Sin compra este mes" style="font-size:11px">‚ö†Ô∏è</span>' : ''}</td>
                    <td><span class="status-badge warning">${c.frecuencia || '-'}</span></td>
                    <td class="text-right" style="color:#64748B">${formatKg(c.historico || 0)}</td>
                    <td class="text-right" style="color:var(--accent);font-weight:700">${formatKg(c.objetivo || 0)}</td>
                    <td class="text-right">${formatKg(c.facturacion || 0)}</td>
                    <td class="text-right">${formatKg(c.pendiente || 0)}</td>
                    <td><span class="status-badge ${statusClass}">${Math.round(pct)}%</span></td>
                </tr>`;
            }).join('');
        }

        async function loadPlanning() {
            const date = dateInput.value;
            let query = `date=${date}`;
            if (vendedor) query += `&vendedor=${vendedor}`;
            if (jefe) query += `&jefe=${encodeURIComponent(jefe)}`;
            if (zona) query += `&zona=${encodeURIComponent(zona)}`;

            try {
                const response = await fetch(`/api/planning?${query}`);
                const data = await response.json();

                document.getElementById('day-meta').textContent = `${data.weekday_name} ‚Ä¢ ${data.target_frequencies.join(' / ')}`;
                document.getElementById('target-freq').textContent = data.target_frequencies.join(', ');

                document.getElementById('kpi-daily-avg').textContent = formatKg(data.stats.daily_average);
                document.getElementById('kpi-daily-needed').textContent = formatKg(data.stats.daily_needed);
                document.getElementById('kpi-clients-count').textContent = data.stats.count;
                document.getElementById('kpi-clients-sum').textContent = formatKg(data.stats.clients_objective_sum);
                document.getElementById('kpi-clients-hist').textContent = formatKg(data.stats.clients_historical_sum);
                document.getElementById('table-count').textContent = data.stats.count;

                allClients = data.clients || [];
                renderTable(allClients);

            } catch (e) {
                console.error(e);
                alert('Error cargando planificaci√≥n');
            }
        }

        loadPlanning();
    </script>

    <div class="valores-watermark">
        <img src="/static/img/valores_minerva.png" alt="Valores Minerva Foods">
    </div>
</body>

</html>