<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swift | Planificación</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .date-selector {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        /* Specific overrides for Planning */
        .kpi-card .value-small {
            font-size: 1.4rem;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <a href="javascript:history.back()">← Volver al Dashboard</a>
        <h1>Planificación Diaria</h1>
    </nav>

    <div class="container">
        <div class="header-row">
            <div>
                <h2>Objetivos del Día</h2>
                <div class="meta" id="day-meta">Cargando...</div>
            </div>
            <div>
                <input type="date" id="planning-date" class="date-selector">
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="label">Objetivo Promedio</div>
                <div class="value value-small" id="kpi-daily-avg">-</div>
                <div class="unit">Base</div>
                <div class="meta">Mensual / 20 días</div>
            </div>

            <div class="kpi-card" style="border-color: var(--accent);">
                <div class="label" style="color: var(--accent);">Necesario Hoy</div>
                <div class="value value-small" style="color: var(--accent);" id="kpi-daily-needed">-</div>
                <div class="unit">Para Cumplir</div>
                <div class="meta"
                    title="Calculado como: (Objetivo Mensual - Ventas Acumuladas) / Días Hábiles Restantes">Brecha /
                    Días Restantes</div>
            </div>

            <div class="kpi-card">
                <div class="label">Clientes a Visitar</div>
                <div class="value" id="kpi-clients-count">-</div>
                <div class="unit">Hoy</div>
            </div>

            <div class="kpi-card">
                <div class="label">Suma Objetivos Clientes</div>
                <div class="value value-small"><span id="kpi-clients-sum">-</span></div>
                <div class="unit">Planificado (Excel)</div>
                <div class="meta">Histórico: <span id="kpi-clients-hist">-</span></div>
            </div>
        </div>

        <div class="table-card">
            <div class="header">
                <h3>Clientes a Visitar (<span id="table-count">0</span>)</h3>
                <div class="meta">Frecuencia: <span id="target-freq">-</span></div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Frecuencia</th>
                        <th class="text-right">Prom. Histórico</th>
                        <th class="text-right">Objetivo Mensual</th>
                        <th class="text-right">Facturado</th>
                        <th class="text-right">Pendiente</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="planning-table">
                    <!-- JS populated -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const vendedor = urlParams.get('vendedor');
        const jefe = urlParams.get('jefe');
        const zona = urlParams.get('zona');

        const dateInput = document.getElementById('planning-date');

        // Set default date to today or from param
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = urlParams.get('date') || today;

        dateInput.addEventListener('change', () => loadPlanning());

        async function loadPlanning() {
            const date = dateInput.value;
            let query = `date=${date}`;
            if (vendedor) query += `&vendedor=${vendedor}`;
            if (jefe) query += `&jefe=${encodeURIComponent(jefe)}`;
            if (zona) query += `&zona=${encodeURIComponent(zona)}`;

            try {
                const response = await fetch(`/api/planning?${query}`);
                const data = await response.json();

                // Header
                document.getElementById('day-meta').textContent = `${data.weekday_name} • ${data.target_frequencies.join(' / ')}`;
                document.getElementById('target-freq').textContent = data.target_frequencies.join(', ');

                // KPIs
                const formatPesos = (val) => '$' + Math.round(val).toLocaleString('es-AR');
                const formatKg = (val) => Math.round(val).toLocaleString('es-AR') + ' kg';

                // Assuming objectives are in KG based on context, but let's check keys.
                // In app.py I summed 'objetivo'. In fact_avance it is usually KG? 
                // Wait, in previous Dashboard it was KG.
                // BUT the user asked for "objetivo de venta del dia (objetivo mensual / dias)". Usually $$$?
                // But dashboard main KPI is KG. Let's assume KG for now or generic units.
                // Actually, fact_avance has 'objetivo' (KG) and 'facturacion' (KG).
                // Monetary objectives are in 'vendedor_objetivos' table.

                // The 'catch-up' logic in app.py summed 'objetivo' from fact_avance. So it's KG.

                document.getElementById('kpi-daily-avg').textContent = formatKg(data.stats.daily_average);
                document.getElementById('kpi-daily-needed').textContent = formatKg(data.stats.daily_needed);
                document.getElementById('kpi-clients-count').textContent = data.stats.count;
                document.getElementById('kpi-clients-sum').textContent = formatKg(data.stats.clients_objective_sum);
                document.getElementById('kpi-clients-hist').textContent = formatKg(data.stats.clients_historical_sum);

                document.getElementById('table-count').textContent = data.stats.count;

                // Table
                const tbody = document.getElementById('planning-table');
                tbody.innerHTML = '';

                data.clients.forEach(c => {
                    const tr = document.createElement('tr');

                    // Simple progress status
                    const pct = c.objetivo ? (c.facturacion + c.pendiente) / c.objetivo * 100 : 0;
                    let statusClass = 'danger';
                    if (pct >= 80) statusClass = 'success';
                    else if (pct >= 50) statusClass = 'warning';

                    tr.innerHTML = `
                         <td>
                            <a href="/cliente/${c.cod_cliente}?vendedor=${vendedor || ''}" style="color: white; font-weight: 500;">
                                ${c.nom_cliente}
                            </a>
                        </td>
                        <td><span class="status-badge warning">${c.frecuencia || '-'}</span></td>
                        <td class="text-right" style="color: #8E8E93;">${formatKg(c.historico || 0)}</td>
                        <td class="text-right" style="color: var(--accent); font-weight: 500;">${formatKg(c.objetivo)}</td>
                        <td class="text-right">${formatKg(c.facturacion)}</td>
                        <td class="text-right">${formatKg(c.pendiente)}</td>
                        <td>
                            <span class="status-badge ${statusClass}">${Math.round(pct)}%</span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error(e);
                alert('Error cargando planificación');
            }
        }

        loadPlanning();
    </script>
</body>

</html>