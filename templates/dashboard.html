<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Swift Sales | Dashboard</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="/static/vendor/echarts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .toggle-group {
            background: rgba(118, 118, 128, 0.12);
            border-radius: 8px;
            padding: 2px;
            display: inline-flex;
        }

        .btn-toggle {
            border: none;
            background: transparent;
            color: #8E8E93;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-card {
            background: #F8FAFF;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            transition: transform 0.2s;
            min-height: 400px;
            /* Ensure visibility */
        }

        .chart-container {
            height: 350px;
            width: 100%;
            position: relative;
        }

        .btn-toggle.active {
            background: #FFF;
            color: #000;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
        }

        /* Tier Badges */
        .tier-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 32px;
            text-align: center;
        }

        .tier-aaa {
            background: linear-gradient(135deg, var(--minerva-yellow), #B8860B);
            color: #000;
            box-shadow: 0 0 12px var(--yellow-glow);
        }

        .tier-aa {
            background: linear-gradient(135deg, #E5E4E2, #B4B4B4);
            color: #000;
        }

        .tier-a {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: #fff;
        }

        .tier-b {
            background: #E2E8F0;
            color: #475569;
            border: 1px solid #CBD5E1;
        }

        .tier-cn {
            background: linear-gradient(135deg, #6A5ACD, #483D8B);
            color: #fff;
            box-shadow: 0 0 8px rgba(106, 90, 205, 0.4);
        }

        /* Sortable Headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            position: relative;
        }

        th.sortable:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        th.sortable::after {
            content: '‚Üï';
            font-size: 0.6rem;
            margin-left: 5px;
            opacity: 0.3;
        }

        th.sortable.sort-asc::after {
            content: '‚ñ≤';
            opacity: 1;
            color: #E84752;
        }

        th.sortable.sort-desc::after {
            content: '‚ñº';
            opacity: 1;
            color: #E84752;
        }

        /* Fecha √∫ltima carga */
        .data-freshness {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(52, 199, 89, 0.12);
            border: 1px solid rgba(52, 199, 89, 0.25);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 11px;
            color: #34c759;
            font-weight: 600;
            letter-spacing: 0.3px;
            margin-top: 6px;
        }

        /* Filas de clientes sin compra en el mes */
        tr.row-sin-compra td {
            background: rgba(255, 69, 58, 0.05) !important;
        }

        tr.row-sin-compra:hover td {
            background: rgba(255, 69, 58, 0.1) !important;
        }

        .alert-icon {
            display: inline-block;
            margin-left: 4px;
            font-size: 12px;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <a class="navbar-brand" href="#" onclick="window.location='/dashboard?'+new URLSearchParams(window.location.search);return false;">
            <span class="brand-name">Minerva <span class="brand-accent">Foods</span></span>
            <span class="brand-sub">Sales Intelligence</span>
        </a>
        <div class="navbar-links">
            <a class="active" href="#" onclick="window.location='/dashboard?'+new URLSearchParams(window.location.search);return false;">üìà Dashboard</a>
            <a href="#" onclick="window.location='/coberturas?'+new URLSearchParams(window.location.search);return false;">üì¶ Coberturas</a>
            <a href="#" onclick="window.location='/mapa?'+new URLSearchParams(window.location.search);return false;">üó∫Ô∏è Mapa</a>
        </div>
        <div class="navbar-extra">
            <a href="/filters">‚öôÔ∏è Cambiar Vista</a>
        </div>
    </nav>

    <div class="container">
        <div class="header-row">
            <div>
                <h2 id="vendedor-name">Dashboard de Ventas</h2>
                <div class="meta" id="vendedor-meta">Visualizaci√≥n unificada de rendimiento comercial</div>
                <div class="data-freshness" id="data-freshness" style="display:none">
                    <span>‚óè</span> <span id="freshness-label">Cargando...</span>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                <!-- Quick month filter buttons (populated by loadMeses) -->
                <div id="month-filters" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
                <div class="month-badge" id="month-badge">‚Äî</div>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="label" id="kpi-objetivo-label">Objetivo Mensual</div>
                <div class="value" id="kpi-objetivo-kg">-</div>
                <div class="unit">KG</div>
            </div>
            <div class="kpi-card">
                <div class="label">Facturado</div>
                <div class="value" id="kpi-facturado-kg">-</div>
                <div class="unit">KG</div>
            </div>
            <div class="kpi-card" id="kpi-pendiente-card">
                <div class="label">Pendiente</div>
                <div class="value" id="kpi-pendiente-kg">-</div>
                <div class="unit">KG</div>
            </div>
            <div class="kpi-card" id="card-cumplimiento">
                <div class="label">Cumplimiento</div>
                <div class="value"><span id="kpi-cumplimiento">-</span>%</div>
                <div class="unit" id="kpi-cumplimiento-unit">vs Objetivo</div>
            </div>
        </div>

        <!-- Monthly evolution mini-chart -->
        <div id="evol-row" style="margin-bottom:16px;display:none;">
            <div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:12px 14px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                    <div style="font-size:0.68rem;font-weight:800;color:#64748B;text-transform:uppercase;letter-spacing:1px;">
                        Evoluci√≥n mensual
                        <span style="color:#94A3B8;font-weight:500;text-transform:none;letter-spacing:0;">¬∑ click para ver ese mes ¬∑ </span>
                        <button id="evol-reset-btn" onclick="activeMonth=null;loadDashboard();loadMeses();"
                            style="font-size:0.65rem;padding:2px 8px;border-radius:10px;border:1.5px solid #1D3557;background:transparent;color:#1D3557;cursor:pointer;font-weight:700;">
                            ‚Ü© Mes Actual
                        </button>
                    </div>
                </div>
                <!-- Scrollable chart wrapper so all bars fit -->
                <div style="overflow-x:auto;">
                    <div id="chart-evolucion" style="height:95px;min-width:420px;"></div>
                </div>
            </div>
        </div>

        <!-- Tachometer Gauges: Facturaci√≥n $, Premium $, Rebozados KG -->
        <div class="tach-grid">
            <div class="tach-card">
                <div class="tach-title">FACTURACI√ìN $</div>
                <div class="tach-value" id="tach-fact-val">0</div>
                <div id="tach-fact" class="tach-container"></div>
                <div class="tach-sub" id="tach-fact-sub">OBJ: ‚Äî</div>
            </div>
            <div class="tach-card">
                <div class="tach-title">PREMIUM $</div>
                <div class="tach-value" id="tach-prem-val">0</div>
                <div id="tach-prem" class="tach-container"></div>
                <div class="tach-sub" id="tach-prem-sub">OBJ: ‚Äî</div>
            </div>
            <div class="tach-card">
                <div class="tach-title">REBOZADOS KG</div>
                <div class="tach-value" id="tach-reb-val">0</div>
                <div id="tach-reb" class="tach-container"></div>
                <div class="tach-sub" id="tach-reb-sub">OBJ: ‚Äî</div>
            </div>
        </div>
        <style>
            @media (max-width: 900px) {
                .tach-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <!-- ‚îÄ‚îÄ INSIGHTS PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div id="insights-panel" style="display:none; margin-bottom:1.5rem;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                <span style="font-size:1rem; font-weight:800; color:var(--text-primary); letter-spacing:-0.3px;">Inteligencia Autom√°tica</span>
                <span id="insights-mes-badge" style="font-size:0.7rem;font-weight:700;background:var(--primary);color:white;padding:2px 8px;border-radius:20px;"></span>
                <span style="font-size:0.75rem;color:var(--text-muted);font-weight:500;">Generado en tiempo real ¬∑ actualiza con cada carga de datos</span>
            </div>
            <div style="display:grid; grid-template-columns: 300px 1fr 1fr; gap:14px; align-items:start;">

                <!-- FORECAST CARD -->
                <div id="insight-forecast" style="background:linear-gradient(135deg,#EFF6FF,#DBEAFE); border:1px solid #BFDBFE; border-radius:14px; padding:18px; box-shadow:0 2px 8px rgba(29,53,87,0.08);">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;">
                        <span style="font-size:0.68rem;font-weight:800;color:#1D4ED8;text-transform:uppercase;letter-spacing:1.5px;" id="fc-section-title">üìà Cierre de Mes</span>
                        <span id="fc-closed-badge" style="display:none;font-size:0.6rem;font-weight:800;background:#E84752;color:white;padding:1px 6px;border-radius:8px;">MES CERRADO</span>
                    </div>
                    <div style="display:flex;align-items:baseline;gap:6px;margin-bottom:4px;">
                        <span id="fc-pct" style="font-size:2.4rem;font-weight:900;color:#1D3557;line-height:1;">‚Äî</span>
                        <span style="font-size:1rem;font-weight:700;color:#64748B;">%</span>
                        <span id="fc-ym-label" style="font-size:0.72rem;color:#64748B;font-weight:600;"></span>
                    </div>
                    <div id="fc-range" style="font-size:0.78rem;color:#475569;font-weight:600;margin-bottom:10px;">rango ‚Äî</div>
                    <div style="background:#BFDBFE;border-radius:4px;height:6px;margin-bottom:10px;overflow:hidden;">
                        <div id="fc-bar" style="height:100%;border-radius:4px;background:linear-gradient(90deg,#3B82F6,#1D3557);transition:width 0.8s ease;width:0%"></div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;" id="fc-grid-current">
                        <div style="background:rgba(255,255,255,0.6);border-radius:8px;padding:8px;text-align:center;">
                            <div id="fc-daily-needed" style="font-size:1rem;font-weight:800;color:#1D3557;">‚Äî</div>
                            <div style="font-size:0.65rem;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:0.8px;margin-top:2px;">KG/d√≠a necesarios</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.6);border-radius:8px;padding:8px;text-align:center;">
                            <div id="fc-days-left" style="font-size:1rem;font-weight:800;color:#1D3557;">‚Äî</div>
                            <div style="font-size:0.65rem;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:0.8px;margin-top:2px;">D√≠as restantes</div>
                        </div>
                    </div>
                    <div id="fc-trend" style="margin-top:8px;font-size:0.78rem;font-weight:700;color:#475569;padding:6px 10px;background:rgba(255,255,255,0.5);border-radius:8px;text-align:center;"></div>
                    <!-- Next month forecast (shown when current month is closed) -->
                    <div id="fc-next" style="display:none;margin-top:10px;border-top:1px solid #BFDBFE;padding-top:10px;">
                        <div style="font-size:0.65rem;font-weight:800;color:#1D4ED8;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">üîÆ Previsi√≥n <span id="fc-next-ym"></span></div>
                        <div style="display:flex;align-items:baseline;gap:4px;">
                            <span id="fc-next-kg" style="font-size:1.3rem;font-weight:900;color:#1D3557;"></span>
                            <span style="font-size:0.75rem;color:#64748B;font-weight:600;">kg</span>
                            <span id="fc-next-pct" style="font-size:0.85rem;font-weight:700;margin-left:4px;"></span>
                        </div>
                        <div id="fc-next-range" style="font-size:0.72rem;color:#64748B;margin-top:2px;"></div>
                        <div id="fc-next-confidence" style="font-size:0.7rem;color:#94A3B8;margin-top:3px;"></div>
                    </div>
                </div>

                <!-- RISK CARD -->
                <div style="background:linear-gradient(135deg,#FFF5F5,#FEE2E2); border:1px solid #FECACA; border-radius:14px; padding:18px; box-shadow:0 2px 8px rgba(232,71,82,0.08);">
                    <div style="font-size:0.68rem;font-weight:800;color:#DC2626;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;">üî¥ Clientes en Riesgo <span id="risk-count" style="background:#FCA5A5;color:#7F1D1D;padding:1px 7px;border-radius:10px;font-size:0.7rem;">0</span></div>
                    <div id="risk-list" style="display:flex;flex-direction:column;gap:6px;max-height:220px;overflow-y:auto;">
                        <div style="color:#94A3B8;font-size:0.8rem;text-align:center;padding:20px 0;">Cargando...</div>
                    </div>
                    <div style="margin-top:10px;font-size:0.72rem;color:#94A3B8;font-weight:500;">Compraron el mes anterior ¬∑ 0 KG este mes</div>
                </div>

                <!-- OPPORTUNITIES CARD -->
                <div style="background:linear-gradient(135deg,#F0FDF4,#DCFCE7); border:1px solid #BBF7D0; border-radius:14px; padding:18px; box-shadow:0 2px 8px rgba(16,185,129,0.08);">
                    <div style="font-size:0.68rem;font-weight:800;color:#15803D;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;">üü¢ Oportunidades del D√≠a <span id="opp-count" style="background:#86EFAC;color:#14532D;padding:1px 7px;border-radius:10px;font-size:0.7rem;">0</span></div>
                    <div id="opp-list" style="display:flex;flex-direction:column;gap:6px;max-height:220px;overflow-y:auto;">
                        <div style="color:#94A3B8;font-size:0.8rem;text-align:center;padding:20px 0;">Cargando...</div>
                    </div>
                    <div style="margin-top:10px;font-size:0.72rem;color:#94A3B8;font-weight:500;">Activos con mayor pendiente ¬∑ ordenados por prioridad</div>
                </div>

            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Evoluci√≥n Diaria (KG) (vs Objetivo)</h3>
                <div id="chart-avance" class="chart-container"></div>
            </div>
            <div class="chart-card day-plan-widget" onclick="goToPlanning()" style="cursor: pointer;">
                <div>
                    <div class="day-plan-date">Planificaci√≥n <span id="plan-date">Hoy</span></div>

                    <div class="day-plan-stat-row">
                        <span class="day-plan-value" id="plan-clients-count">-</span>
                        <span class="day-plan-label">Clientes a Visitar</span>
                    </div>

                    <div class="day-plan-stat-row">
                        <span class="day-plan-value" id="plan-objective">-</span>
                        <span class="day-plan-label">Objetivo del D√≠a</span>
                    </div>
                </div>

                <button class="day-plan-action">Ver Plan Detallado ‚Üí</button>
            </div>
        </div>

        <div class="table-card">
            <div class="header">
                <h3>Detalle de Clientes (<span id="total-clientes">0</span>)</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="sortable" onclick="changeSort('nom_cliente')" id="col-nom_cliente"
                            style="width: 25%">Cliente</th>
                        <th class="sortable" onclick="changeSort('frecuencia')" id="col-frecuencia">Freq</th>
                        <th class="sortable" onclick="changeSort('tier')" id="col-tier">Tier</th>
                        <th class="sortable text-right" onclick="changeSort('facturacion')" id="col-facturacion">Fact
                            (KG)</th>
                        <th class="sortable text-right" onclick="changeSort('objetivo')" id="col-objetivo">Obj (KG)</th>
                        <th class="sortable text-right" onclick="changeSort('facturacion_pesos')"
                            id="col-facturacion_pesos">Fact ($)</th>
                        <th class="sortable text-right" onclick="changeSort('objetivo_pesos')" id="col-objetivo_pesos">
                            Obj ($)</th>
                        <th class="sortable text-right" onclick="changeSort('pct')" id="col-pct">%</th>
                        <th class="sortable text-right" onclick="changeSort('trend_pct')" id="col-trend_pct" title="Variaci√≥n vs mes anterior">Tend.</th>
                        <th>Estado</th>
                    </tr>
                </thead>

                <tbody id="clients-table">
                    <!-- JS populated -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let globalClientes = [];
        let clientMode = 'kg';
        let currentSortKey = 'facturacion';
        let sortAsc = false;


        const urlParams = new URLSearchParams(window.location.search);
        const vendedor = urlParams.get('vendedor');
        const jefe = urlParams.get('jefe');
        const zona = urlParams.get('zona');

        const formatKg = (val) => val ? Math.round(val).toLocaleString('es-AR') + ' kg' : '0 kg';
        const formatKgShort = (val) => val ? Math.round(val).toLocaleString('es-AR') : '0';
        const formatPesos = (val) => {
            if (!val) return '0';
            if (val >= 1000000) return '$' + (val / 1000000).toFixed(1) + 'M';
            if (val >= 1000) return '$' + (val / 1000).toFixed(0) + 'K';
            return '$' + Math.round(val).toLocaleString('es-AR');
        };

        function getStatusClass(pct) {
            if (pct >= 80) return 'success';
            if (pct >= 50) return 'warning';
            return 'danger';
        }

        function setClientMode(mode) {
            clientMode = mode;
            document.querySelectorAll('.btn-toggle').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            renderClientsTable(globalClientes);
        }

        function goToPlanning() {
            let params = [];
            if (vendedor) params.push(`vendedor=${vendedor}`);
            if (zona) params.push(`zona=${encodeURIComponent(zona)}`);
            if (jefe) params.push(`jefe=${encodeURIComponent(jefe)}`);
            window.location.href = `/planning?${params.join('&')}`;
        }

        async function loadMeta() {
            try {
                const res = await fetch('/api/meta');
                const meta = await res.json();
                if (meta.ultima_carga_label) {
                    const el = document.getElementById('data-freshness');
                    document.getElementById('freshness-label').textContent = `Datos al ${meta.ultima_carga_label}`;
                    el.style.display = 'inline-flex';
                }
                if (meta.mes_activo) {
                    const [y, m] = meta.mes_activo.split('-');
                    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    document.getElementById('month-badge').textContent = `${meses[parseInt(m) - 1]} ${y}`;
                }
            } catch (e) { console.log('meta fetch error', e); }
        }

        let activeMonth = null;   // null = current avance month
        let baseQuery = '';

        async function loadMeses() {
            if (!vendedor && !jefe && !zona) return;
            let q = vendedor ? `vendedor=${vendedor}` : jefe ? `jefe=${encodeURIComponent(jefe)}` : `zona=${encodeURIComponent(zona)}`;
            try {
                const res = await fetch(`/api/dashboard/meses-disponibles?${q}`);
                const data = await res.json();
                const container = document.getElementById('month-filters');
                container.innerHTML = '';
                (data.meses || []).forEach(m => {
                    const btn = document.createElement('button');
                    btn.textContent = m.label;
                    btn.dataset.ym = m.ym;
                    btn.style.cssText = `font-size:0.7rem;font-weight:700;padding:4px 10px;border-radius:20px;border:1.5px solid;cursor:pointer;transition:all 0.2s;`;
                    const isSelected = (activeMonth === m.ym) || (activeMonth === null && m.is_active);
                    btn.style.background    = isSelected ? '#1D3557' : 'transparent';
                    btn.style.color         = isSelected ? '#fff' : '#475569';
                    btn.style.borderColor   = isSelected ? '#1D3557' : '#CBD5E1';
                    btn.onclick = () => {
                        activeMonth = m.ym;
                        loadDashboard();
                        loadMeses();  // re-render buttons
                    };
                    container.appendChild(btn);
                });
            } catch(e) { console.warn('loadMeses error', e); }
        }

        function renderEvolMiniChart(evol) {
            if (!evol || evol.length < 2) { document.getElementById('evol-row').style.display = 'none'; return; }
            document.getElementById('evol-row').style.display = 'block';

            // Show/hide "Mes Actual" reset button
            const resetBtn = document.getElementById('evol-reset-btn');
            resetBtn.style.display = (activeMonth && !evol.find(e=>e.ym===activeMonth)?.is_active) ? 'inline' : 'none';

            const dom = document.getElementById('chart-evolucion');
            // Resize to fit all bars (min 60px per bar)
            dom.style.minWidth = Math.max(420, evol.length * 72) + 'px';
            let chart = echarts.getInstanceByDom(dom);
            if (chart) chart.dispose();
            chart = echarts.init(dom);

            const mesNames = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            const labels = evol.map(e => {
                const [y,m] = e.ym.split('-');
                return mesNames[parseInt(m)-1]+' '+y.slice(2) + (e.is_active ? ' ‚òÖ' : '');
            });
            const vals = evol.map(e => e.kg);

            chart.setOption({
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    formatter: p => {
                        const e = evol[p[0].dataIndex];
                        const tag = e.is_active ? ' <b>(Mes Activo)</b>' : '';
                        return `<b>${p[0].name.replace(' ‚òÖ','')}</b>${tag}<br/>${formatKgShort(p[0].value)} kg`;
                    }
                },
                grid: { top: 8, right: 8, bottom: 28, left: 52 },
                xAxis: {
                    type: 'category', data: labels,
                    axisLabel: { fontSize: 10, color: '#475569', fontWeight: '600' },
                    axisLine: { lineStyle: { color: '#E2E8F0' } }, axisTick: { show: false }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { fontSize: 9, color: '#94A3B8', formatter: v => v>=1000?(v/1000).toFixed(0)+'t':v },
                    splitLine: { lineStyle: { color: '#F1F5F9' } }
                },
                series: [{
                    type: 'bar',
                    data: vals.map((v,i) => {
                        const e = evol[i];
                        const isSelected = e.is_selected || (activeMonth === null && e.is_active) || (activeMonth === e.ym);
                        const color = e.is_active ? '#E84752' : (isSelected ? '#1D3557' : '#93C5FD');
                        return {
                            value: v,
                            itemStyle: {
                                color, borderRadius: [4,4,0,0],
                                opacity: isSelected ? 1 : 0.7
                            }
                        };
                    }),
                    barWidth: '58%',
                    label: { show: true, position: 'top', fontSize: 9, color: '#475569', fontWeight: '700',
                             formatter: p => formatKgShort(p.value) }
                }]
            });
            chart.off('click');
            chart.on('click', params => {
                const clicked = evol[params.dataIndex];
                // If clicking the active month ‚Üí reset to live view
                if (clicked.is_active) {
                    activeMonth = null;
                } else {
                    activeMonth = clicked.ym;
                }
                loadDashboard();
                loadMeses();
            });
        }

        async function loadDashboard() {
            // Allow loading if any filter is present
            if (!vendedor && !jefe && !zona) { window.location.href = '/filters'; return; }

            if (!baseQuery) {
                if (vendedor) baseQuery = `vendedor=${vendedor}`;
                else if (jefe) baseQuery = `jefe=${encodeURIComponent(jefe)}`;
                else if (zona) baseQuery = `zona=${encodeURIComponent(zona)}`;
            }

            const monthParam = activeMonth ? `&month=${activeMonth}` : '';
            const response = await fetch(`/api/dashboard?${baseQuery}${monthParam}`);
            const data = await response.json();
            if (data.error) { alert(data.error); return; }

            // Save for toggle
            globalClientes = data.clientes || [];

            const isHistorical = data.is_historical || false;
            const monthLabel   = data.month_label || '';

            // Dynamic title
            const type = data.vendedor.type ? `[${data.vendedor.type}] ` : '';
            const nombreCompleto = type + data.vendedor.nombre;
            document.title = `Swift Sales | ${nombreCompleto}`;

            // Header
            document.getElementById('vendedor-name').textContent = nombreCompleto;
            let meta = '';
            if (data.vendedor.zona) meta += data.vendedor.zona;
            if (data.vendedor.jefe) meta += ` ‚Ä¢ ${data.vendedor.jefe}`;
            meta += ` ‚Ä¢ ${data.vendedor.total_clientes} clientes`;
            if (isHistorical) meta += ` ¬∑ üìÖ ${monthLabel}`;
            document.getElementById('vendedor-meta').textContent = meta;

            // Month badge
            if (monthLabel) document.getElementById('month-badge').textContent = monthLabel;

            // KPIs
            document.getElementById('kpi-objetivo-kg').textContent = formatKgShort(data.kpis.objetivo);
            document.getElementById('kpi-facturado-kg').textContent = formatKgShort(data.kpis.facturacion);

            if (isHistorical) {
                // Historical: hide pendiente, show compradores count instead
                document.getElementById('kpi-pendiente-card').style.opacity = '0.4';
                document.getElementById('kpi-pendiente-kg').textContent = data.kpis.compradores ? `${data.kpis.compradores} cl.` : '‚Äî';
                document.getElementById('kpi-pendiente-card').querySelector('.label').textContent = 'Compradores';
                document.getElementById('kpi-objetivo-label').textContent = 'Obj. Ref. (Actual)';
                document.getElementById('kpi-cumplimiento-unit').textContent = 'vs Obj. Actual';
            } else {
                document.getElementById('kpi-pendiente-card').style.opacity = '1';
                document.getElementById('kpi-pendiente-kg').textContent = formatKgShort(data.kpis.pendiente);
                document.getElementById('kpi-pendiente-card').querySelector('.label').textContent = 'Pendiente';
                document.getElementById('kpi-objetivo-label').textContent = 'Objetivo Mensual';
                document.getElementById('kpi-cumplimiento-unit').textContent = 'vs Objetivo';
            }

            const pct = data.kpis.cumplimiento_pct;
            const card = document.getElementById('card-cumplimiento');
            card.style.background = pct >= 80 ? 'linear-gradient(135deg, #30D158, #208e3b)' :
                pct >= 50 ? 'linear-gradient(135deg, #FF9F0A, #d48806)' :
                    'linear-gradient(135deg, #FF453A, #c0392b)';
            document.getElementById('kpi-cumplimiento').textContent = data.kpis.cumplimiento_pct;
            document.getElementById('total-clientes').textContent = `${data.clientes.length} clientes`;

            // Monthly evolution chart
            renderEvolMiniChart(data.evolucion || []);

            if (!isHistorical) {
                renderBurnChart(data.chart);
                // Populate Plan Widget
                const date = new Date();
                const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                document.getElementById('plan-date').textContent = `${dayNames[date.getDay()]} ${date.getDate()}`;
            }

            renderClientsTable(globalClientes);

            // Load monetary facturacion + Planning Summary (only for live month)
            if (!isHistorical) loadFacturacion(baseQuery);
        }

        async function loadFacturacion(query) {
            try {
                const id = vendedor || 'global';
                const response = await fetch(`/api/vendedor/${id}/facturacion?${query}`);
                const data = await response.json();

                if (data.facturacion) {
                    const f = data.facturacion;
                    const o = data.objetivos || {};

                    // Populate Plan Objective (daily estimate)
                    if (o.objetivo_pesos) {
                        const dailyObj = o.objetivo_pesos / 20;
                        const el = document.getElementById('plan-objective');
                        if (el) el.textContent = formatPesos(dailyObj);
                    }

                    // Render tachometers with all monetary data
                    renderDashboardGauges(
                        f.total_pesos, o.objetivo_pesos,
                        f.premium_pesos, o.objetivo_premium_pesos,
                        f.rebozados_kg, o.objetivo_rebozados_kg
                    );
                }
            } catch (e) {
                console.log('No facturacion data available', e);
            }
        }

        function renderDashboardGauges(factAct, factObj, premAct, premObj, rebAct, rebObj) {
            rendTach('tach-fact', factAct || 0, factObj || 0, formatPesos, 'tach-fact-sub');
            rendTach('tach-prem', premAct || 0, premObj || 0, formatPesos, 'tach-prem-sub');
            rendTach('tach-reb', rebAct || 0, rebObj || 0, formatKg, 'tach-reb-sub');
        }

        function rendTach(id, actual, objetivo, fmtFn, subId) {
            const dom = document.getElementById(id);
            const existing = echarts.getInstanceByDom(dom);
            if (existing) existing.dispose();
            const chart = echarts.init(dom);

            const MAX = 130;
            const pct = objetivo > 0 ? Math.min((actual / objetivo) * 100, MAX) : 0;
            const pctRaw = objetivo > 0 ? (actual / objetivo) * 100 : 0;

            chart.setOption({
                backgroundColor: 'transparent',
                series: [{
                    type: 'gauge',
                    startAngle: 210,
                    endAngle: -30,
                    min: 0,
                    max: MAX,
                    radius: '100%',
                    center: ['50%', '65%'],
                    splitNumber: 13,
                    axisLine: {
                        lineStyle: {
                            width: 10, // Thinner, more elegant track
                            color: [
                                [0.40, '#E84752'], // Red
                                [0.70, '#F6AD55'], // Better Yellow
                                [0.90, '#68D391'], // Soft Green
                                [1.00, '#38A169']  // Strong Green
                            ]
                        }
                    },
                    progress: {
                        show: true, width: 10,
                        itemStyle: { color: 'rgba(29, 53, 87, 0.1)' }
                    },
                    splitLine: { length: 8, lineStyle: { color: '#CBD5E1', width: 1.5 } },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#64748B', fontSize: 10, distance: 15, fontWeight: '600',
                        formatter: v => v % 20 === 0 ? v : ''
                    },
                    pointer: {
                        length: '75%', width: 5, icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z',
                        offsetCenter: [0, '-10%'],
                        itemStyle: { color: '#1D3557', shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.1)' }
                    },
                    anchor: {
                        show: true, showAbove: true, size: 10,
                        itemStyle: { color: '#1D3557', borderColor: '#fff', borderWidth: 2 }
                    },
                    detail: {
                        valueAnimation: true,
                        offsetCenter: [0, '25%'],
                        formatter: () => `{pct|${pctRaw.toFixed(1)}%}`,
                        rich: {
                            pct: {
                                fontSize: 16, color: pct >= 100 ? '#10B981' : '#475569',
                                fontWeight: '800', lineHeight: 24,
                                backgroundColor: '#F8FAFC', padding: [4, 12], borderRadius: 6,
                                borderBottom: '2px solid' + (pct >= 100 ? '#10B981' : '#CBD5E1')
                            }
                        }
                    },
                    data: [{ value: parseFloat(pct.toFixed(1)) }]
                }]
            });

            const valId = id + '-val';
            if (document.getElementById(valId)) {
                document.getElementById(valId).textContent = fmtFn(actual);
            }

            if (subId) document.getElementById(subId).textContent = `OBJ: ${fmtFn(objetivo)}`;
        }

        // Remove the accidental renderCharts function from previous edit if it exists

        function renderBurnChart(chartData) {
            if (!chartData || !chartData.dates) {
                console.warn('No chart data available');
                return;
            }

            console.log('Rendering Burn Chart with data:', chartData);
            const dom = document.getElementById('chart-avance');
            if (!dom) {
                console.error('Chart container #chart-avance not found');
                return;
            }
            const myChart = echarts.init(dom);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#E2E8F0',
                    textStyle: { color: '#1E293B' }
                },
                legend: {
                    show: true,
                    top: '0%',
                    right: '5%',
                    textStyle: { color: '#475569', fontWeight: '600', fontSize: 11 },
                    itemGap: 20
                },
                grid: { left: '3%', right: '4%', bottom: '5%', top: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: chartData.dates,
                    axisLabel: { color: '#475569', fontWeight: '600', fontSize: 11 },
                    axisLine: { lineStyle: { color: '#CBD5E1', width: 1 } },
                    axisTick: { show: false }
                },
                yAxis: {
                    type: 'value',
                    splitLine: { lineStyle: { type: 'dashed', color: '#E2E8F0' } },
                    axisLabel: { color: '#475569', fontWeight: '600', fontSize: 11 },
                    axisLine: { show: false }
                },
                series: [
                    {
                        name: 'OBJETIVO',
                        type: 'line',
                        data: chartData.ideal,
                        lineStyle: { type: 'dashed', color: '#94A3B8', width: 2 },
                        showSymbol: false,
                        itemStyle: { color: '#94A3B8' }
                    },
                    {
                        name: 'VENTA REAL',
                        type: 'line',
                        data: chartData.actual,
                        lineStyle: { width: 4, cap: 'round' },
                        itemStyle: { color: '#1D3557' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(29, 53, 87, 0.15)' },
                                { offset: 1, color: 'rgba(29, 53, 87, 0)' }
                            ])
                        },
                        symbolSize: 6,
                        showSymbol: true
                    },
                    {
                        name: 'VENTA + PENDIENTE',
                        type: 'line',
                        data: chartData.real_plus_pend,
                        itemStyle: { color: '#E84752' },
                        lineStyle: { width: 3, type: 'dashed' },
                        symbolSize: 6,
                        showSymbol: true
                    },
                    {
                        name: 'PROYECCI√ìN',
                        type: 'line',
                        data: chartData.projection,
                        lineStyle: { type: 'dotted', color: '#6A5ACD', width: 3 },
                        itemStyle: { color: '#6A5ACD' }
                    }

                ]
            };

            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }

        function renderClientsTable(clientes) {
            const tbody = document.getElementById('clients-table');

            // Sort data before rendering
            const sorted = [...clientes].sort((a, b) => {
                let v1 = a[currentSortKey];
                let v2 = b[currentSortKey];

                // Special handling for calculated % field
                if (currentSortKey === 'pct') {
                    v1 = a.objetivo ? ((a.facturacion || 0) + (a.pendiente || 0)) / a.objetivo : 0;
                    v2 = b.objetivo ? ((b.facturacion || 0) + (b.pendiente || 0)) / b.objetivo : 0;
                }

                // Tier sorting order
                if (currentSortKey === 'tier') {
                    const order = { 'AAA': 4, 'AA': 3, 'A': 2, 'B': 1 };
                    v1 = order[v1 || 'B'] || 0;
                    v2 = order[v2 || 'B'] || 0;
                }

                if (v1 < v2) return sortAsc ? -1 : 1;
                if (v1 > v2) return sortAsc ? 1 : -1;
                return 0;
            });

            // Update header UI
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const activeHeader = document.getElementById(`col-${currentSortKey}`);
            if (activeHeader) {
                activeHeader.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');
            }

            tbody.innerHTML = sorted.map(c => {
                const totalKg = (c.facturacion || 0) + (c.pendiente || 0);
                const objKg = c.objetivo || 0;

                const pctValue = objKg ? Math.round(totalKg / objKg * 100) : 0;
                const status = getStatusClass(pctValue);

                // Fila roja: tiene objetivo pero facturaci√≥n = 0 en el mes (cliente sin compra)
                const sinCompra = (c.facturacion || 0) === 0 && objKg > 0;
                const rowClass = sinCompra ? 'row-sin-compra' : '';
                const alertIcon = sinCompra ? '<span class="alert-icon" title="Sin compra este mes">‚ö†Ô∏è</span>' : '';

                // Trend indicator
                let trendHtml = '<td class="text-right">‚Äî</td>';
                if (c.trend_pct !== null && c.trend_pct !== undefined) {
                    const tp = c.trend_pct;
                    if (tp === 0) {
                        trendHtml = `<td class="text-right" style="color:#94A3B8;font-weight:600;font-size:0.8rem;">‚Üí</td>`;
                    } else {
                        const sign = tp > 0 ? '+' : '';
                        const col  = tp > 0 ? '#10B981' : '#E84752';
                        const arr  = tp > 0 ? '‚Üë' : '‚Üì';
                        trendHtml = `<td class="text-right" style="color:${col};font-weight:700;font-size:0.8rem;">${arr} ${sign}${tp}%</td>`;
                    }
                } else if (c.facturacion > 0) {
                    trendHtml = `<td class="text-right" style="color:#F59E0B;font-weight:700;font-size:0.75rem;" title="Nuevo comprador">‚òÖ Nuevo</td>`;
                }

                return `
                    <tr class="${rowClass}" onclick="window.location.href='/cliente/${c.cod_cliente}?vendedor=${vendedor || ''}'">
                        <td><strong>${c.nom_cliente || 'N/A'}</strong>${alertIcon}</td>
                        <td>${c.frecuencia || '-'}</td>
                        <td><span class="tier-badge tier-${(c.tier || 'B').toLowerCase()}">${c.tier || 'B'}</span></td>
                        <td class="text-right">${formatKgShort(c.facturacion || 0)}</td>
                        <td class="text-right">${formatKgShort(c.objetivo || 0)}</td>
                        <td class="text-right">${formatPesos(c.facturacion_pesos || 0)}</td>
                        <td class="text-right">${formatPesos(c.objetivo_pesos || 0)}</td>
                        <td class="text-right"><strong>${pctValue}%</strong></td>
                        ${trendHtml}
                        <td><span class="status-badge ${status}">${pctValue}%</span></td>
                    </tr>
                `;

            }).join('');
        }

        function changeSort(key) {
            if (currentSortKey === key) {
                sortAsc = !sortAsc;
            } else {
                currentSortKey = key;
                sortAsc = (key === 'nom_cliente' || key === 'frecuencia'); // Names asc by default, numbers desc
            }
            renderClientsTable(globalClientes);
        }


        // ‚îÄ‚îÄ INSIGHTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const TIER_COLOR = { AAA: '#D4AF37', AA: '#94A3B8', A: '#CD7F32', B: '#64748B', CN: '#6D28D9' };
        const fmtKg = v => v ? Math.round(v).toLocaleString('es-AR') + ' kg' : '‚Äî';

        function renderInsightItem(item, type) {
            const tier = item.tier || 'B';
            const tc = TIER_COLOR[tier] || '#94A3B8';
            const telHtml = item.telefono
                ? `<a href="tel:${item.telefono}" onclick="event.stopPropagation()" style="font-size:0.7rem;color:#64748B;text-decoration:none;" title="Llamar">üìû</a>`
                : '';

            if (type === 'risk') {
                return `<div style="background:rgba(255,255,255,0.65);border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer;"
                    onclick="window.location.href='/cliente/${item.cod_cliente}?vendedor=${vendedor||''}'">
                    <span style="font-size:0.65rem;font-weight:800;padding:2px 6px;border-radius:4px;background:${tc}22;color:${tc};flex-shrink:0;">${tier}</span>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:0.78rem;font-weight:700;color:#1E293B;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.nom_cliente}</div>
                        <div style="font-size:0.7rem;color:#64748B;">Ant: ${fmtKg(item.kg_prev_month)} ¬∑ ${item.contacto || ''}</div>
                    </div>
                    ${telHtml}
                </div>`;
            } else {
                const pct = item.pct_objetivo || 0;
                const sc = item.priority_score || 0;
                return `<div style="background:rgba(255,255,255,0.65);border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer;"
                    onclick="window.location.href='/cliente/${item.cod_cliente}?vendedor=${vendedor||''}'">
                    <span style="font-size:0.65rem;font-weight:800;padding:2px 6px;border-radius:4px;background:${tc}22;color:${tc};flex-shrink:0;">${tier}</span>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:0.78rem;font-weight:700;color:#1E293B;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.nom_cliente}</div>
                        <div style="font-size:0.7rem;color:#64748B;">Pend: ${fmtKg(item.pendiente)} ¬∑ ${pct}% obj ¬∑ Score ${sc}</div>
                    </div>
                    ${telHtml}
                </div>`;
            }
        }

        async function loadInsights() {
            if (!vendedor && !jefe && !zona) return;
            let q = [];
            if (vendedor) q.push(`vendedor=${vendedor}`);
            if (jefe) q.push(`jefe=${encodeURIComponent(jefe)}`);
            if (zona) q.push(`zona=${encodeURIComponent(zona)}`);

            try {
                const res = await fetch(`/api/insights?${q.join('&')}`);
                if (!res.ok) return;
                const d = await res.json();

                document.getElementById('insights-panel').style.display = 'block';

                // Mes badge
                if (d.mes) {
                    const [y, m] = d.mes.split('-');
                    const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                    document.getElementById('insights-mes-badge').textContent = `${meses[parseInt(m)-1]} ${y}`;
                }

                // Forecast
                const fc = d.forecast;
                const fcPct = fc.proj_pct;
                const isClosed = fc.is_month_closed;

                // Month label
                const ymParts = (fc.cur_ym || '').split('-');
                const mesNames = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                const ymLabel = ymParts.length===2 ? mesNames[parseInt(ymParts[1])-1]+' '+ymParts[0] : '';
                document.getElementById('fc-ym-label').textContent = ymLabel;

                if (isClosed) {
                    document.getElementById('fc-section-title').textContent = '‚úÖ Resultado Final';
                    document.getElementById('fc-closed-badge').style.display = 'inline';
                    document.getElementById('fc-grid-current').style.display = 'none';
                    document.getElementById('fc-range').style.display = 'none';
                    // Show pendiente note if any
                    if (fc.pend_kg && fc.pend_kg > 0) {
                        const pendNote = document.getElementById('fc-trend');
                        pendNote.style.display = 'block';
                        pendNote.innerHTML = `<span style="color:#F59E0B;">‚ö† Incluye ${Math.round(fc.pend_kg).toLocaleString('es-AR')} kg pendientes sin facturar</span>`;
                    }
                } else {
                    document.getElementById('fc-range').textContent = `rango ${fc.low_pct}% ‚Äì ${fc.high_pct}%`;
                    document.getElementById('fc-daily-needed').textContent = fc.daily_needed
                        ? Math.round(fc.daily_needed).toLocaleString('es-AR') : '‚Äî';
                    document.getElementById('fc-days-left').textContent = fc.days_remaining ?? '‚Äî';
                }

                document.getElementById('fc-pct').textContent = fcPct;
                document.getElementById('fc-pct').style.color = fcPct >= 80 ? '#10B981' : fcPct >= 50 ? '#F59E0B' : '#E84752';
                document.getElementById('fc-bar').style.width = Math.min(fcPct, 100) + '%';
                document.getElementById('fc-bar').style.background = fcPct >= 80
                    ? 'linear-gradient(90deg,#10B981,#059669)'
                    : fcPct >= 50 ? 'linear-gradient(90deg,#F59E0B,#D97706)' : 'linear-gradient(90deg,#E84752,#DC2626)';

                if (fc.trend_vs_prev_pct !== null && fc.trend_vs_prev_pct !== undefined) {
                    const tp = fc.trend_vs_prev_pct;
                    const sign = tp >= 0 ? '+' : '';
                    const col = tp >= 0 ? '#10B981' : '#E84752';
                    const arr = tp >= 0 ? '‚Üë' : '‚Üì';
                    document.getElementById('fc-trend').innerHTML =
                        `<span style="color:${col}">${arr} ${sign}${tp}% vs mes anterior</span>`;
                } else {
                    document.getElementById('fc-trend').style.display = 'none';
                }

                // Next-month multi-factor forecast
                if (fc.next_forecast_kg) {
                    document.getElementById('fc-next').style.display = 'block';
                    const nymParts = (fc.next_ym || '').split('-');
                    document.getElementById('fc-next-ym').textContent = nymParts.length===2 ? mesNames[parseInt(nymParts[1])-1]+' '+nymParts[0] : '';
                    document.getElementById('fc-next-kg').textContent = Math.round(fc.next_forecast_kg).toLocaleString('es-AR');
                    if (fc.next_proj_pct) {
                        const npct = fc.next_proj_pct;
                        const nc = npct >= 100 ? '#10B981' : npct >= 80 ? '#F59E0B' : '#E84752';
                        document.getElementById('fc-next-pct').innerHTML = `<span style="color:${nc};font-weight:800;">${npct}%</span> <span style="font-size:0.7rem;color:#94A3B8;">del objetivo</span>`;
                    }
                    if (fc.next_low_kg && fc.next_high_kg) {
                        document.getElementById('fc-next-range').textContent =
                            `Rango: ${Math.round(fc.next_low_kg).toLocaleString('es-AR')} ‚Äì ${Math.round(fc.next_high_kg).toLocaleString('es-AR')} kg`;
                    }
                    document.getElementById('fc-next-confidence').textContent =
                        `Confianza: ${fc.next_confidence || '‚Äî'}% ¬∑ Baseline + Tendencia + Estacionalidad + Recencia`;
                }

                // Risk
                document.getElementById('risk-count').textContent = d.risk.length;
                document.getElementById('risk-list').innerHTML = d.risk.length
                    ? d.risk.map(r => renderInsightItem(r, 'risk')).join('')
                    : '<div style="color:#94A3B8;font-size:0.8rem;text-align:center;padding:20px 0;">‚úÖ Sin clientes en riesgo</div>';

                // Opportunities
                document.getElementById('opp-count').textContent = d.opportunities.length;
                document.getElementById('opp-list').innerHTML = d.opportunities.length
                    ? d.opportunities.map(o => renderInsightItem(o, 'opp')).join('')
                    : '<div style="color:#94A3B8;font-size:0.8rem;text-align:center;padding:20px 0;">Sin oportunidades pendientes</div>';

            } catch (e) { console.error('Insights error:', e); }
        }

        window.addEventListener('resize', () => {
            echarts.getInstanceByDom(document.getElementById('chart-avance'))?.resize();
            echarts.getInstanceByDom(document.getElementById('chart-clientes'))?.resize();
        });

        loadMeta();
        loadDashboard();
        loadMeses();
        loadInsights();
    </script>

    <div class="valores-watermark">
        <img src="/static/img/valores_minerva.png" alt="Valores Minerva Foods">
    </div>
</body>

</html>