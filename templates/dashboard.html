<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Swift Sales | Dashboard</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="/static/vendor/echarts.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .toggle-group {
            background: rgba(118, 118, 128, 0.12);
            border-radius: 8px;
            padding: 2px;
            display: inline-flex;
        }

        .btn-toggle {
            border: none;
            background: transparent;
            color: #8E8E93;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-toggle.active {
            background: #FFF;
            color: #000;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
        }

        /* Tier Badges */
        .tier-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 32px;
            text-align: center;
        }

        .tier-aaa {
            background: linear-gradient(135deg, #FFD700, #DAA520);
            color: #000;
            box-shadow: 0 0 8px rgba(218, 165, 32, 0.4);
        }

        .tier-aa {
            background: linear-gradient(135deg, #E5E4E2, #B4B4B4);
            color: #000;
        }

        .tier-a {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: #fff;
        }

        .tier-b {
            background: #333;
            color: #888;
            border: 1px solid #444;
        }

        .tier-cn {
            background: linear-gradient(135deg, #6A5ACD, #483D8B);
            color: #fff;
            box-shadow: 0 0 8px rgba(106, 90, 205, 0.4);
        }

        /* Sortable Headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            position: relative;
        }

        th.sortable:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        th.sortable::after {
            content: '‚Üï';
            font-size: 0.6rem;
            margin-left: 5px;
            opacity: 0.3;
        }

        th.sortable.sort-asc::after {
            content: '‚ñ≤';
            opacity: 1;
            color: #E84752;
        }

        th.sortable.sort-desc::after {
            content: '‚ñº';
            opacity: 1;
            color: #E84752;
        }

        /* Fecha √∫ltima carga */
        .data-freshness {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(52, 199, 89, 0.12);
            border: 1px solid rgba(52, 199, 89, 0.25);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 11px;
            color: #34c759;
            font-weight: 600;
            letter-spacing: 0.3px;
            margin-top: 6px;
        }

        /* Filas de clientes sin compra en el mes */
        tr.row-sin-compra td {
            background: rgba(255, 69, 58, 0.05) !important;
        }

        tr.row-sin-compra:hover td {
            background: rgba(255, 69, 58, 0.1) !important;
        }

        .alert-icon {
            display: inline-block;
            margin-left: 4px;
            font-size: 12px;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <h1>Swift Sales Intelligence</h1>
        <div style="display:flex;gap:16px;align-items:center">
            <a href="#"
                onclick="window.location='/coberturas?'+new URLSearchParams(window.location.search);return false;">üìä
                Coberturas</a>
            <a href="/filters">‚Üê Cambiar Vista</a>
        </div>
    </nav>

    <div class="container">
        <div class="header-row">
            <div>
                <h2 id="vendedor-name">Dashboard de Ventas</h2>
                <div class="meta" id="vendedor-meta">Visualizaci√≥n unificada de rendimiento comercial</div>
                <div class="data-freshness" id="data-freshness" style="display:none">
                    <span>‚óè</span> <span id="freshness-label">Cargando...</span>
                </div>
            </div>
            <div class="month-badge" id="month-badge">‚Äî</div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="label">Objetivo Mensual</div>
                <div class="value" id="kpi-objetivo-kg">-</div>
                <div class="unit">KG</div>
            </div>
            <div class="kpi-card">
                <div class="label">Facturado</div>
                <div class="value" id="kpi-facturado-kg">-</div>
                <div class="unit">KG</div>
            </div>
            <div class="kpi-card">
                <div class="label">Pendiente</div>
                <div class="value" id="kpi-pendiente-kg">-</div>
                <div class="unit">KG</div>
            </div>
            <div class="kpi-card" id="card-cumplimiento">
                <div class="label">Cumplimiento</div>
                <div class="value"><span id="kpi-cumplimiento">-</span>%</div>
                <div class="unit">vs Objetivo</div>
            </div>
        </div>

        <!-- Tachometer Gauges: Facturaci√≥n $, Premium $, Rebozados KG -->
        <div class="tach-grid">
            <div class="tach-card">
                <div class="tach-title">FACTURACI√ìN $</div>
                <div id="tach-fact" class="tach-container"></div>
                <div class="tach-sub" id="tach-fact-sub">Obj: ‚Äî</div>
            </div>
            <div class="tach-card">
                <div class="tach-title">PREMIUM $</div>
                <div id="tach-prem" class="tach-container"></div>
                <div class="tach-sub" id="tach-prem-sub">Obj: ‚Äî</div>
            </div>
            <div class="tach-card">
                <div class="tach-title">REBOZADOS KG</div>
                <div id="tach-reb" class="tach-container"></div>
                <div class="tach-sub" id="tach-reb-sub">Obj: ‚Äî</div>
            </div>
        </div>
        <style>
            .tach-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
                margin-bottom: 2rem;
            }

            .tach-card {
                background: radial-gradient(ellipse at center, #1a1a1a 0%, #0a0a0a 100%);
                border: 1px solid #2a2a2a;
                border-radius: 16px;
                padding: 1rem 1rem 0.6rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.04);
                position: relative;
                overflow: hidden;
            }

            .tach-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(90deg, transparent, #E84752, transparent);
            }

            .tach-title {
                font-size: 0.7rem;
                font-weight: 800;
                color: #555;
                letter-spacing: 2px;
                text-transform: uppercase;
                margin-bottom: 0.2rem;
            }

            .tach-container {
                width: 100%;
                height: 210px;
            }

            .tach-sub {
                font-size: 0.8rem;
                color: #aaaaaa;
                font-weight: 700;
                letter-spacing: 1px;
                padding-bottom: 0.5rem;
                text-transform: uppercase;
            }

            @media (max-width: 900px) {
                .tach-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Evoluci√≥n Diaria (KG) (vs Objetivo)</h3>
                <div id="chart-avance" class="chart-container"></div>
            </div>
            <div class="chart-card day-plan-widget" onclick="goToPlanning()" style="cursor: pointer;">
                <div>
                    <div class="day-plan-date">Planificaci√≥n <span id="plan-date">Hoy</span></div>

                    <div class="day-plan-stat-row">
                        <span class="day-plan-value" id="plan-clients-count">-</span>
                        <span class="day-plan-label">Clientes a Visitar</span>
                    </div>

                    <div class="day-plan-stat-row">
                        <span class="day-plan-value" id="plan-objective">-</span>
                        <span class="day-plan-label">Objetivo del D√≠a</span>
                    </div>
                </div>

                <button class="day-plan-action">Ver Plan Detallado ‚Üí</button>
            </div>
        </div>

        <div class="table-card">
            <div class="header">
                <h3>Detalle de Clientes (<span id="total-clientes">0</span>)</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="sortable" onclick="changeSort('nom_cliente')" id="col-nom_cliente"
                            style="width: 25%">Cliente</th>
                        <th class="sortable" onclick="changeSort('frecuencia')" id="col-frecuencia">Freq</th>
                        <th class="sortable" onclick="changeSort('tier')" id="col-tier">Tier</th>
                        <th class="sortable text-right" onclick="changeSort('facturacion')" id="col-facturacion">Fact
                            (KG)</th>
                        <th class="sortable text-right" onclick="changeSort('objetivo')" id="col-objetivo">Obj (KG)</th>
                        <th class="sortable text-right" onclick="changeSort('facturacion_pesos')"
                            id="col-facturacion_pesos">Fact ($)</th>
                        <th class="sortable text-right" onclick="changeSort('objetivo_pesos')" id="col-objetivo_pesos">
                            Obj ($)</th>
                        <th class="sortable text-right" onclick="changeSort('pct')" id="col-pct">%</th>
                        <th>Estado</th>
                    </tr>
                </thead>

                <tbody id="clients-table">
                    <!-- JS populated -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let globalClientes = [];
        let clientMode = 'kg';
        let currentSortKey = 'facturacion';
        let sortAsc = false;


        const urlParams = new URLSearchParams(window.location.search);
        const vendedor = urlParams.get('vendedor');
        const jefe = urlParams.get('jefe');
        const zona = urlParams.get('zona');

        const formatKg = (val) => val ? Math.round(val).toLocaleString('es-AR') + ' kg' : '0 kg';
        const formatKgShort = (val) => val ? Math.round(val).toLocaleString('es-AR') : '0';
        const formatPesos = (val) => {
            if (!val) return '0';
            if (val >= 1000000) return '$' + (val / 1000000).toFixed(1) + 'M';
            if (val >= 1000) return '$' + (val / 1000).toFixed(0) + 'K';
            return '$' + Math.round(val).toLocaleString('es-AR');
        };

        function getStatusClass(pct) {
            if (pct >= 80) return 'success';
            if (pct >= 50) return 'warning';
            return 'danger';
        }

        function setClientMode(mode) {
            clientMode = mode;
            document.querySelectorAll('.btn-toggle').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            renderClientsTable(globalClientes);
        }

        function goToPlanning() {
            let params = [];
            if (vendedor) params.push(`vendedor=${vendedor}`);
            if (zona) params.push(`zona=${encodeURIComponent(zona)}`);
            if (jefe) params.push(`jefe=${encodeURIComponent(jefe)}`);
            window.location.href = `/planning?${params.join('&')}`;
        }

        async function loadMeta() {
            try {
                const res = await fetch('/api/meta');
                const meta = await res.json();
                if (meta.ultima_carga_label) {
                    const el = document.getElementById('data-freshness');
                    document.getElementById('freshness-label').textContent = `Datos al ${meta.ultima_carga_label}`;
                    el.style.display = 'inline-flex';
                }
                if (meta.mes_activo) {
                    const [y, m] = meta.mes_activo.split('-');
                    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    document.getElementById('month-badge').textContent = `${meses[parseInt(m) - 1]} ${y}`;
                }
            } catch (e) { console.log('meta fetch error', e); }
        }

        async function loadDashboard() {
            // Allow loading if any filter is present
            if (!vendedor && !jefe && !zona) { window.location.href = '/filters'; return; }

            let query = '';
            if (vendedor) query = `vendedor=${vendedor}`;
            else if (jefe) query = `jefe=${encodeURIComponent(jefe)}`;
            else if (zona) query = `zona=${encodeURIComponent(zona)}`;

            const response = await fetch(`/api/dashboard?${query}`);
            const data = await response.json();
            if (data.error) { alert(data.error); return; }

            // Save for toggle
            globalClientes = data.clientes || [];

            // Dynamic title
            const type = data.vendedor.type ? `[${data.vendedor.type}] ` : '';
            const nombreCompleto = type + data.vendedor.nombre;
            document.title = `Swift Sales | ${nombreCompleto}`;

            // Header
            document.getElementById('vendedor-name').textContent = nombreCompleto;

            let meta = '';
            if (data.vendedor.zona) meta += data.vendedor.zona;
            if (data.vendedor.jefe) meta += ` ‚Ä¢ ${data.vendedor.jefe}`;
            meta += ` ‚Ä¢ ${data.vendedor.total_clientes} clientes`;

            document.getElementById('vendedor-meta').textContent = meta;

            // KPIs
            document.getElementById('kpi-objetivo-kg').textContent = formatKgShort(data.kpis.objetivo);
            document.getElementById('kpi-facturado-kg').textContent = formatKgShort(data.kpis.facturacion);
            document.getElementById('kpi-pendiente-kg').textContent = formatKgShort(data.kpis.pendiente);

            const pct = data.kpis.cumplimiento_pct;
            const card = document.getElementById('card-cumplimiento');
            card.style.background = pct >= 80 ? 'linear-gradient(135deg, #30D158, #208e3b)' :
                pct >= 50 ? 'linear-gradient(135deg, #FF9F0A, #d48806)' :
                    'linear-gradient(135deg, #FF453A, #c0392b)';

            document.getElementById('kpi-cumplimiento').textContent = data.kpis.cumplimiento_pct;
            document.getElementById('total-clientes').textContent = `${data.clientes.length} clientes`;

            renderBurnChart(data.chart);

            // Populate Plan Widget
            const date = new Date();
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            document.getElementById('plan-date').textContent = `${dayNames[date.getDay()]} ${date.getDate()}`;

            renderClientsTable(globalClientes);

            // Load monetary facturacion + Planning Summary
            loadFacturacion(query);
        }

        async function loadFacturacion(query) {
            try {
                const id = vendedor || 'global';
                const response = await fetch(`/api/vendedor/${id}/facturacion?${query}`);
                const data = await response.json();

                if (data.facturacion) {
                    const f = data.facturacion;
                    const o = data.objetivos || {};

                    // Populate Plan Objective (daily estimate)
                    if (o.objetivo_pesos) {
                        const dailyObj = o.objetivo_pesos / 20;
                        const el = document.getElementById('plan-objective');
                        if (el) el.textContent = formatPesos(dailyObj);
                    }

                    // Render tachometers with all monetary data
                    renderDashboardGauges(
                        f.total_pesos, o.objetivo_pesos,
                        f.premium_pesos, o.objetivo_premium_pesos,
                        f.rebozados_kg, o.objetivo_rebozados_kg
                    );
                }
            } catch (e) {
                console.log('No facturacion data available', e);
            }
        }

        function renderDashboardGauges(factAct, factObj, premAct, premObj, rebAct, rebObj) {
            rendTach('tach-fact', factAct || 0, factObj || 0, formatPesos, 'tach-fact-sub');
            rendTach('tach-prem', premAct || 0, premObj || 0, formatPesos, 'tach-prem-sub');
            rendTach('tach-reb', rebAct || 0, rebObj || 0, formatKg, 'tach-reb-sub');
        }

        function rendTach(id, actual, objetivo, fmtFn, subId) {
            const dom = document.getElementById(id);
            const existing = echarts.getInstanceByDom(dom);
            if (existing) existing.dispose();
            const chart = echarts.init(dom);

            const MAX = 130;
            const pct = objetivo > 0 ? Math.min((actual / objetivo) * 100, MAX) : 0;
            const pctRaw = objetivo > 0 ? (actual / objetivo) * 100 : 0;

            chart.setOption({
                backgroundColor: 'transparent',
                series: [{
                    type: 'gauge',
                    startAngle: 215,
                    endAngle: -35,
                    min: 0,
                    max: MAX,
                    radius: '90%',
                    center: ['50%', '60%'],
                    splitNumber: 13,
                    axisLine: {
                        lineStyle: {
                            width: 18,
                            color: [
                                [0.50, '#1a1a1a'],
                                [0.65, '#252525'],
                                [0.77, '#333333'],
                                [0.84, '#5a0a0a'],
                                [1.00, '#E84752']
                            ]
                        }
                    },
                    splitLine: { length: 12, lineStyle: { color: '#404040', width: 2 } },
                    axisTick: { length: 6, splitNumber: 5, lineStyle: { color: '#303030', width: 1 } },
                    axisLabel: {
                        color: '#777', fontSize: 10, distance: 10, fontWeight: '600',
                        formatter: v => v === 0 ? '0' : v === 100 ? '100%' : v === MAX ? '130%' : ''
                    },
                    pointer: {
                        length: '68%', width: 6,
                        itemStyle: { color: '#E84752', shadowBlur: 16, shadowColor: 'rgba(232,71,82,0.9)' }
                    },
                    anchor: {
                        show: true, showAbove: true, size: 14,
                        itemStyle: {
                            color: '#0a0a0a', borderColor: '#E84752', borderWidth: 2,
                            shadowBlur: 10, shadowColor: '#E84752'
                        }
                    },
                    detail: {
                        valueAnimation: true,
                        offsetCenter: [0, '28%'],
                        formatter: () => `{val|${fmtFn(actual)}}\n{pct|${pctRaw.toFixed(1)}%}`,
                        rich: {
                            val: { fontSize: 18, fontWeight: '700', color: '#ffffff', lineHeight: 26 },
                            pct: {
                                fontSize: 13, color: pct >= 100 ? '#E84752' : '#888',
                                fontWeight: '700', lineHeight: 20
                            }
                        }
                    },
                    data: [{ value: parseFloat(pct.toFixed(1)) }]
                }]
            });

            if (subId) document.getElementById(subId).textContent = `OBJ: ${fmtFn(objetivo)}`;
        }

        function renderBurnChart(chartData) {
            if (!chartData || !chartData.dates) {
                console.warn('No chart data available');
                return;
            }

            const dom = document.getElementById('chart-avance');
            if (!dom) return;

            const myChart = echarts.init(dom);

            const option = {
                tooltip: { trigger: 'axis' },
                legend: { show: false },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: chartData.dates },
                yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed' } } },
                series: [
                    {
                        name: 'Objetivo',
                        type: 'line',
                        data: chartData.ideal,
                        lineStyle: { type: 'dashed', color: '#999' },
                        showSymbol: false
                    },
                    {
                        name: 'Real',
                        type: 'line',
                        data: chartData.actual,
                        itemStyle: { color: '#007AFF' },
                        areaStyle: { color: 'rgba(0,122,255,0.1)' }
                    },
                    {
                        name: 'Real + Pendiente',
                        type: 'line',
                        data: chartData.real_plus_pend,
                        itemStyle: { color: '#4CD964' },
                        lineStyle: { width: 2 }
                    },
                    {
                        name: 'Proyecci√≥n',
                        type: 'line',
                        data: chartData.projection,
                        lineStyle: { type: 'dotted', color: '#FF9500' }
                    }

                ]
            };

            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }

        function renderClientsTable(clientes) {
            const tbody = document.getElementById('clients-table');

            // Sort data before rendering
            const sorted = [...clientes].sort((a, b) => {
                let v1 = a[currentSortKey];
                let v2 = b[currentSortKey];

                // Special handling for calculated % field
                if (currentSortKey === 'pct') {
                    v1 = a.objetivo ? ((a.facturacion || 0) + (a.pendiente || 0)) / a.objetivo : 0;
                    v2 = b.objetivo ? ((b.facturacion || 0) + (b.pendiente || 0)) / b.objetivo : 0;
                }

                // Tier sorting order
                if (currentSortKey === 'tier') {
                    const order = { 'AAA': 4, 'AA': 3, 'A': 2, 'B': 1 };
                    v1 = order[v1 || 'B'] || 0;
                    v2 = order[v2 || 'B'] || 0;
                }

                if (v1 < v2) return sortAsc ? -1 : 1;
                if (v1 > v2) return sortAsc ? 1 : -1;
                return 0;
            });

            // Update header UI
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const activeHeader = document.getElementById(`col-${currentSortKey}`);
            if (activeHeader) {
                activeHeader.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');
            }

            tbody.innerHTML = sorted.map(c => {
                const totalKg = (c.facturacion || 0) + (c.pendiente || 0);
                const objKg = c.objetivo || 0;

                const pctValue = objKg ? Math.round(totalKg / objKg * 100) : 0;
                const status = getStatusClass(pctValue);

                // Fila roja: tiene objetivo pero facturaci√≥n = 0 en el mes (cliente sin compra)
                const sinCompra = (c.facturacion || 0) === 0 && objKg > 0;
                const rowClass = sinCompra ? 'row-sin-compra' : '';
                const alertIcon = sinCompra ? '<span class="alert-icon" title="Sin compra este mes">‚ö†Ô∏è</span>' : '';

                return `
                    <tr class="${rowClass}" onclick="window.location.href='/cliente/${c.cod_cliente}?vendedor=${vendedor || ''}'">
                        <td><strong>${c.nom_cliente || 'N/A'}</strong>${alertIcon}</td>
                        <td>${c.frecuencia || '-'}</td>
                        <td><span class="tier-badge tier-${(c.tier || 'B').toLowerCase()}">${c.tier || 'B'}</span></td>
                        <td class="text-right">${formatKgShort(c.facturacion || 0)}</td>
                        <td class="text-right">${formatKgShort(c.objetivo || 0)}</td>
                        <td class="text-right">${formatPesos(c.facturacion_pesos || 0)}</td>
                        <td class="text-right">${formatPesos(c.objetivo_pesos || 0)}</td>
                        <td class="text-right"><strong>${pctValue}%</strong></td>
                        <td><span class="status-badge ${status}">${pctValue}%</span></td>
                    </tr>
                `;

            }).join('');
        }

        function changeSort(key) {
            if (currentSortKey === key) {
                sortAsc = !sortAsc;
            } else {
                currentSortKey = key;
                sortAsc = (key === 'nom_cliente' || key === 'frecuencia'); // Names asc by default, numbers desc
            }
            renderClientsTable(globalClientes);
        }


        window.addEventListener('resize', () => {
            echarts.getInstanceByDom(document.getElementById('chart-avance'))?.resize();
            echarts.getInstanceByDom(document.getElementById('chart-clientes'))?.resize();
        });

        loadMeta();
        loadDashboard();
    </script>
</body>

</html>